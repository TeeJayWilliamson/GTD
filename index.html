<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greater Toronto Doulas - Management System</title>
    <style>
        :root {
            --primary: #8b7355;
            --secondary: #d4a574;
            --bg: #f8f5f2;
            --white: #ffffff;
            --text: #444;
            --gray-light: #e8e0d8;
            --danger: #c17b5f;
            --success: #6b8e23;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--secondary);
        }
        h1 { color: var(--primary); font-weight: 300; letter-spacing: 1px; margin-bottom: 5px;}
        .tagline { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--primary);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-btn.active, .tab-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(139, 115, 85, 0.2);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary); font-weight: 300; margin-bottom: 20px; }
        h3 { color: var(--primary); font-weight: 400; margin-bottom: 15px; font-size: 1.1em; }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input, .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .search-input { width: 100%; max-width: 300px; }

        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .list-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-color: var(--secondary);
        }
        .list-item-name {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--primary);
        }
        .list-item-icon { color: var(--secondary); font-size: 1.2em; }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 10px;
        }
        th {
            text-align: left;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        tr {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        td { padding: 15px; border-top: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); vertical-align: middle; }
        td:first-child { border-left: 1px solid var(--gray-light); border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: 500; color: var(--primary); }
        td:last-child { border-right: 1px solid var(--gray-light); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        .paycheck-service-list { list-style: none; font-size: 0.9em; }
        .paycheck-service-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dashed #eee; }
        .paycheck-service-row:last-child { border-bottom: none; }
        .paycheck-amount { font-weight: 600; color: #666; margin-left: 10px; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: background 0.2s;
        }
        .btn:hover { background: #6d5942; }
        
        .btn-secondary { background: var(--gray-light); color: var(--primary); }
        .btn-small { padding: 6px 12px; font-size: 0.8em; margin-right: 5px; border-radius: 4px; }        
        .btn-edit { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-add-line { background: var(--secondary); margin-top: 10px; width: 100%; }
        .btn-remove-line { background: var(--danger); padding: 5px 10px; margin-left: 10px; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px); align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fefefe; padding: 30px; border-radius: 12px;
            width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--gray-light); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 2rem; cursor: pointer; border: none; background: none; color: #999; line-height: 1; }
        
        .detail-row { display: flex; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
        .detail-label { width: 180px; font-weight: 600; color: #888; flex-shrink: 0; }
        .detail-value { color: #333; flex-grow: 1; }
        .detail-actions { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--gray-light); text-align: right; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        input, select, textarea { padding: 12px; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1em; background: #fafafa; width: 100%; }
        
        #bookingServicesContainer label, #bookingDoulasContainer label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
        }

        #bookingServicesContainer label span, #bookingDoulasContainer label span {
            display: inline-block;
            transform: translateY(-1px);
        }

        #bookingServicesContainer input[type="checkbox"],
        #bookingServicesContainer input[type="radio"],
        #bookingDoulasContainer input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            flex-shrink: 0;
        }

        .login-form-container {
            padding: 30px;
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-form-container h2 {
            color: var(--primary);
            margin-bottom: 25px;
        }
        .login-form-container .form-group {
            margin-bottom: 20px;
        }
        .login-form-container input[type="text"], 
        .login-form-container input[type="password"] {
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            width: 100%;
        }
        .login-form-container .btn {
            width: 100%;
            margin-top: 15px;
        }

        .action-btns {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: nowrap;
            align-items: center;
            width: fit-content;
            max-width: 200px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 25px;
            text-align: center;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 300;
            color: var(--primary);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .service-hours-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 5px;
        }

        .service-hours-input input {
            width: 80px;
        }

        .booking-selection-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .booking-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .booking-item:last-child {
            border-bottom: none;
        }

        .booking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .booking-header:hover {
            background: #f9f9f9;
        }

        .booking-expand-icon {
            font-size: 1.2em;
            transition: transform 0.2s;
            color: var(--secondary);
        }

        .booking-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .booking-services-container {
            display: none;
            margin-left: 30px;
            margin-top: 5px;
            padding-left: 15px;
            border-left: 2px solid var(--secondary);
        }

        .booking-services-container.expanded {
            display: block;
        }

        .booking-item-details {
            flex: 1;
        }

        .booking-service-item {
            margin-left: 30px;
            padding: 8px;
            background: #fff;
            border-left: 2px solid var(--secondary);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .booking-service-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .booking-service-hours {
            width: 80px;
            padding: 4px;
            font-size: 0.9em;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch input[type="checkbox"] {
            width: auto;
            height: auto;
        }

        .paycheck-summary {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .controls-bar { flex-direction: column-reverse; align-items: stretch; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid var(--gray-light); border-radius: 8px; padding: 10px; }
            td { border: none; padding: 8px 5px; display: flex; justify-content: space-between; text-align: right; }
            td::before { content: attr(data-label) ":"; font-weight: bold; text-transform: uppercase; margin-right: 10px; color: #777; flex-shrink: 0; }
            td:first-child, td:last-child { border-radius: 0; }
            .action-btns { justify-content: flex-end; width: 100%; }
        }
        @media (max-width: 500px) {
             .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="loginModal" class="modal active">
        <div class="login-form-container">
            <h2>GTD Management Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
                <p id="loginMessage" style="color: var(--danger); margin-top: 10px;"></p>
            </form>
        </div>
    </div>
    
    <div id="mainAppContainer" style="display: none;">
        <div class="container">

            <header style="position: relative;">
                <h1>Greater Toronto Doulas</h1>
                <p class="tagline">Management System</p>
                <button class="btn btn-secondary btn-small" style="position: absolute; top: 10px; right: 20px;" onclick="handleLogout()">Logout</button>
            </header>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('bookings', event)">Bookings</button>
                <button class="tab-btn" onclick="switchTab('doulas', event)">Doulas</button>
                <button class="tab-btn" onclick="switchTab('services', event)">Services</button>
                <button class="tab-btn" onclick="switchTab('paychecks', event)">Paychecks</button>
                <button class="tab-btn" onclick="switchTab('summary', event)">Reports</button>
            </div>

            <div id="bookingsTab" class="tab-content active">
                <div class="controls-bar">
                    <button class="btn" onclick="newBooking()">+ New Booking</button>
                    <input type="text" id="bookingSearch" class="search-input" placeholder="Search Bookings..." onkeyup="renderBookings()">
                    <select id="bookingStatusFilter" class="filter-select" onchange="renderBookings()">
                        <option value="">All Statuses</option>
                        <option value="Pending Start">Pending Start</option>
                        <option value="Current">Current</option>
                        <option value="Archive">Archive</option>
                    </select>
                </div>
                <div id="bookingsList" class="list-container"></div>
            </div>

            <div id="doulasTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newDoula()">+ Add New Doula</button>
                    <input type="text" id="doulaSearch" class="search-input" placeholder="Search Doulas..." onkeyup="renderDoulas()">
                </div>
                <div id="doulasList" class="list-container"></div>
            </div>
            
            <div id="servicesTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newService()">+ Add New Service</button>
                    <input type="text" id="serviceSearch" class="search-input" placeholder="Search Services..." onkeyup="renderServices()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Client Price</th>
                            <th>Doula Payout</th>
                            <th>Agency Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody"></tbody>
                </table>
            </div>

            <div id="paychecksTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newPaycheck()">+ Generate Paycheck</button>
                    <select id="paycheckWeekFilter" class="filter-select" onchange="renderPaychecks()">
                        <option value="">All Weeks</option>
                    </select>
                    <select id="paycheckDoulaFilter" class="filter-select" onchange="renderPaychecks()">
                        <option value="">All Doulas</option>
                    </select>
                </div>
                <table id="paychecksTable">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Doula</th>
                            <th>Date</th>
                            <th>Bookings</th>
                            <th>Services</th>
                            <th>Total Payout</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paychecksTableBody"></tbody>
                </table>
                
                <div class="paycheck-summary">
                    <h3>Weekly Summary</h3>
                    <div id="paycheckWeeklySummary"></div>
                </div>
            </div>

            <div id="summaryTab" class="tab-content">
                <h2>Summary Report</h2>
                <div id="summaryStats" class="stat-grid"></div>
                <h2>Services Performed This Week</h2>
                <div class="controls-bar">
                    <input type="week" id="reportWeek" class="filter-select" onchange="renderSummary()">
                </div>
                <div id="servicesReportContainer"></div>
            </div>

        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookingModalTitle">New Booking</h2>
                <button class="close-btn" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" name="invoiceNumber">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Booking Status</label>
                        <select name="bookingStatus">
                            <option value="Pending Start">Pending Start</option>
                            <option value="Current">Current</option>
                            <option value="Archive">Archive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select name="paymentStatus">
                            <option value="Deposit">Deposit</option>
                            <option value="Paid in Full">Paid in Full</option>
                            <option value="Up to Date">Up to Date</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Assigned Doula(s) *</label>
                        <div class="multi-select-checkbox-group" id="bookingDoulasContainer"></div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services *</label>
                        <div class="multi-select-checkbox-group" id="bookingServicesContainer"></div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bookingModal')">Cancel</button>
                    <button type="submit" class="btn">Save Booking</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Doula Modal -->
    <div id="doulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="doulaModalTitle">Add Doula</h2>
                <button class="close-btn" onclick="closeModal('doulaModal')">&times;</button>
            </div>
            <form id="doulaForm" onsubmit="saveDoula(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>SIN Number</label>
                        <input type="text" name="sinNumber">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Address</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services Offered (Comma Separated)</label>
                        <textarea name="servicesOffered"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="cprCertified">
                            <span>CPR Certified</span>
                        </label>
                        <input type="date" name="cprExpiry" placeholder="CPR Expiration Date">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="policeCheck">
                            <span>Police Reference Check</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="insuranceUpToDate">
                            <span>Up to Date Insurance</span>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('doulaModal')">Cancel</button>
                    <button type="submit" class="btn">Save Doula</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Service Modal -->
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Add Service</h2>
                <button class="close-btn" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Name *</label>
                        <input type="text" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Price * ($)</label>
                        <input type="number" name="clientPrice" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Doula Payout * ($)</label>
                        <input type="number" name="doulaPayout" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Agency Profit * ($)</label>
                        <input type="number" name="agencyProfit" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('serviceModal')">Cancel</button>
                    <button type="submit" class="btn">Save Service</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Paycheck Modal -->
    <div id="paycheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paycheckModalTitle">Generate Paycheck</h2>
                <button class="close-btn" onclick="closeModal('paycheckModal')">&times;</button>
            </div>
            <form id="paycheckForm" onsubmit="savePaycheck(event)">
                <input type="hidden" name="id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Doula *</label>
                        <select name="doula" id="paycheckDoula" required onchange="loadDoulaBookings()">
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="text" name="weekNumber" placeholder="e.g., 01, 02, 45" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" name="invoiceDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="hstToggle" onchange="calculatePaycheckTotals()">
                        <span>Include HST (13%)</span>
                    </label>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px dashed var(--gray-light);">
                <h3>Select Bookings & Services to Pay For</h3>
                
                <div id="paycheckBookingsContainer" class="booking-selection-list">
                    <p style="color: #999; text-align: center;">Select a doula to see their bookings</p>
                </div>

                <div style="margin-top: 20px; text-align: right; font-size: 1.1em;">
                    <p>Subtotal: <strong id="paycheckSubtotal">$0.00</strong></p>
                    <p id="paycheckHstRow" style="display: none;">HST (13%): <strong id="paycheckHst">$0.00</strong></p>
                    <p style="font-size: 1.4em; font-weight: bold; color: var(--primary);">Total Payout: <strong id="paycheckTotal">$0.00</strong></p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paycheckModal')">Cancel</button>
                    <button type="submit" class="btn">Save Paycheck</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsModalTitle">Details</h2>
                <button class="close-btn" onclick="closeModal('detailsModal')">&times;</button>
            </div>
            <div id="detailsModalBody"></div>
            <div id="detailsModalActions" class="detail-actions"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://gtd-1rkv.onrender.com';
        const AUTH_KEY = 'gtd_admin_logged_in';
        const STATIC_USERNAME = 'GTDAdmin';
        const STATIC_PASSWORD = 'Doula@123';

        let bookings = [];
        let doulas = [];
        let services = [];
        let paychecks = [];
        let editingId = null;

        // --- UTILS ---

        function formatPhone(str) {
            if(!str) return '';
            const cleaned = ('' + str).replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return '(' + match[1] + ') ' + match[2] + '-' + match[3];
            }
            return str;
        }

        function escapeHtml(unsafe) {
            if (unsafe === undefined || unsafe === null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return String(weekNo).padStart(2, '0');
        }

        function getWeekRange(weekNumber, year) {
            const simple = new Date(year, 0, 1 + (weekNumber - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            const ISOweekEnd = new Date(ISOweekStart);
            ISOweekEnd.setDate(ISOweekStart.getDate() + 6);
            return { start: ISOweekStart, end: ISOweekEnd };
        }
        
        // --- API HELPERS ---
        async function apiCall(method, path, data) {
            const response = await fetch(API_BASE + path, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: data ? JSON.stringify(data) : undefined,
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            return response.json();
        }

        const apiGet = (path) => apiCall('GET', path);
        const apiPost = (path, data) => apiCall('POST', path, data);
        const apiPut = (path, data) => apiCall('PUT', path, data);
        const apiDelete = (path) => apiCall('DELETE', path);
        
        // --- AUTH LOGIC ---

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        async function handleLogin(e) {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const messageEl = document.getElementById('loginMessage');
            
            if (username === STATIC_USERNAME && password === STATIC_PASSWORD) {
                localStorage.setItem(AUTH_KEY, 'true');
                showMainApp();
            } else {
                messageEl.textContent = 'Invalid username or password.';
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem(AUTH_KEY);
                window.location.reload();
            }
        }

        // --- TAB SWITCHING ---

        function switchTab(tabId, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            window.scrollTo(0, 0); 
        }

        // --- BOOKINGS ---

        function renderBookings() {
            const container = document.getElementById('bookingsList');
            const searchTerm = document.getElementById('bookingSearch').value.toLowerCase();
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            
            const filteredBookings = bookings.filter(b => {
                const matchesSearch = 
                    (b.clientName && b.clientName.toLowerCase().includes(searchTerm)) ||
                    (b.assignedDoulas && b.assignedDoulas.toLowerCase().includes(searchTerm)) ||
                    (b.invoiceNumber && b.invoiceNumber.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || b.bookingStatus === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            container.innerHTML = filteredBookings.map(b => `
                <div class="list-item" onclick="showBookingDetails(${b.id})">
                    <div class="list-item-name">${escapeHtml(b.clientName)} - ${escapeHtml(b.assignedDoulas || 'Unassigned')}</div>
                    <div class="list-item-icon">${escapeHtml(b.bookingStatus || 'Current')}</div>
                </div>
            `).join('');
        }

        function newBooking() {
            editingId = null;
            openModal('bookingModal');
        }

        function showBookingDetails(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsModalTitle').textContent = `Booking Details: ${escapeHtml(booking.clientName)}`;
            const body = document.getElementById('detailsModalBody');
            const actions = document.getElementById('detailsModalActions');

            const b = booking;
            
            const servicesDisplay = (b.serviceDetails || []).map(sd => 
                `${escapeHtml(sd.name)}${sd.hours ? ` (${sd.hours} hrs)` : ''}`
            ).join(', ') || escapeHtml(b.services || 'None');

            body.innerHTML = `
                <div class="detail-row"><span class="detail-label">Client Name:</span><span class="detail-value">${escapeHtml(b.clientName)}</span></div>
                <div class="detail-row"><span class="detail-label">Invoice Number:</span><span class="detail-value">${escapeHtml(b.invoiceNumber || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Due Date:</span><span class="detail-value">${escapeHtml(b.dueDate || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(b.phone)}">${formatPhone(b.phone)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(b.email)}">${escapeHtml(b.email)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Doula(s):</span><span class="detail-value">${escapeHtml(b.assignedDoulas || 'Unassigned')}</span></div>
                <div class="detail-row"><span class="detail-label">Booking Status:</span><span class="detail-value">${escapeHtml(b.bookingStatus || 'Current')}</span></div>
                <div class="detail-row"><span class="detail-label">Payment Status:</span><span class="detail-value">${escapeHtml(b.paymentStatus || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value">${servicesDisplay}</span></div>
                <div class="detail-row"><span class="detail-label">Total Due:</span><span class="detail-value">${calculateBookingTotal(b).toFixed(2)}</span></div>
            `;
            actions.innerHTML = `
                <button class="btn btn-edit" onclick="editBooking(${b.id})">Edit Booking</button>
                <button class="btn btn-danger" onclick="deleteItem('booking', ${b.id})">Delete</button>
            `;
            modal.classList.add('active');
        }

        function calculateBookingTotal(booking) {
            if (!booking.serviceDetails || booking.serviceDetails.length === 0) return 0;
            
            return booking.serviceDetails.reduce((total, sd) => {
                const service = services.find(s => s.serviceName === sd.name);
                if (service) {
                    const hours = sd.hours || 1;
                    return total + (service.clientPrice * hours);
                }
                return total;
            }, 0);
        }

        // --- DOULAS ---

        function renderDoulas() {
            const container = document.getElementById('doulasList');
            const searchTerm = document.getElementById('doulaSearch').value.toLowerCase();
            
            if (!doulas || doulas.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">No doulas found.</p>';
                return;
            }

            const filteredDoulas = doulas.filter(d => 
                (d.name && d.name.toLowerCase().includes(searchTerm)) ||
                (d.servicesOffered && d.servicesOffered.toLowerCase().includes(searchTerm))
            );
            
            container.innerHTML = filteredDoulas.map(d => `
                <div class="list-item" onclick="showDoulaDetails(${d.id})">
                    <div class="list-item-name">${escapeHtml(d.name)}</div>
                    <div class="list-item-icon">${escapeHtml(d.servicesOffered || 'No services listed')}</div>
                </div>
            `).join('');
        }

        function newDoula() {
            editingId = null;
            openModal('doulaModal');
        }

        function showDoulaDetails(id) {
            const doula = doulas.find(d => d.id === id);
            if (!doula) return;

            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsModalTitle').textContent = `Doula Details: ${escapeHtml(doula.name)}`;
            const body = document.getElementById('detailsModalBody');
            const actions = document.getElementById('detailsModalActions');

            const d = doula;
            
            const currentBookings = bookings.filter(b => 
                b.assignedDoulas && b.assignedDoulas.includes(d.name) && b.bookingStatus === 'Current'
            );
            
            const bookingsHtml = currentBookings.length > 0 
                ? currentBookings.map(b => `<div>${escapeHtml(b.clientName)} (Invoice: ${escapeHtml(b.invoiceNumber || 'N/A')})</div>`).join('')
                : '<div style="color: #999;">No current bookings</div>';

            const cprStatus = d.cprCertified ? 'Yes' + (d.cprExpiry ? ` (Expires: ${d.cprExpiry})` : '') : 'No';

            body.innerHTML = `
                <div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value">${escapeHtml(d.name)}</span></div>
                <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(d.phone)}">${formatPhone(d.phone)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(d.email)}">${escapeHtml(d.email)}</a></span></div>
                <div class="detail-row"><span class="detail-label">SIN Number:</span><span class="detail-value">${escapeHtml(d.sinNumber || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Address:</span><span class="detail-value">${escapeHtml(d.address || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value">${escapeHtml(d.servicesOffered || 'None listed')}</span></div>
                <div class="detail-row"><span class="detail-label">CPR Certified:</span><span class="detail-value">${cprStatus}</span></div>
                <div class="detail-row"><span class="detail-label">Police Check:</span><span class="detail-value">${d.policeCheck ? 'Yes' : 'No'}</span></div>
                <div class="detail-row"><span class="detail-label">Insurance:</span><span class="detail-value">${d.insuranceUpToDate ? 'Up to Date' : 'Not Current'}</span></div>
                <div class="detail-row"><span class="detail-label">Current Bookings:</span><span class="detail-value">${bookingsHtml}</span></div>
            `;
            actions.innerHTML = `
                <button class="btn btn-edit" onclick="editDoula(${d.id})">Edit Doula</button>
                <button class="btn btn-danger" onclick="deleteItem('doula', ${d.id})">Delete</button>
            `;
            modal.classList.add('active');
        }

        // --- SERVICES ---
        
        function renderServices() {
            const container = document.getElementById('servicesTableBody');
            const searchTerm = document.getElementById('serviceSearch').value.toLowerCase();
            
            const filteredServices = services.filter(s => 
                (s.serviceName && s.serviceName.toLowerCase().includes(searchTerm))
            );

            container.innerHTML = filteredServices.map(s => `
                <tr>
                    <td data-label="Service Name">${escapeHtml(s.serviceName)}</td>
                    <td data-label="Client Price">${Number(s.clientPrice).toFixed(2)}</td>
                    <td data-label="Doula Payout">${Number(s.doulaPayout).toFixed(2)}</td>
                    <td data-label="Agency Profit">${Number(s.agencyProfit).toFixed(2)}</td>
                    <td data-label="Actions">
                        <button class="btn btn-small btn-edit" onclick="editService(${s.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteItem('service', ${s.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function newService() {
            editingId = null;
            openModal('serviceModal');
        }

        function editService(id) {
            const service = services.find(s => s.id === id);
            if (!service) return;

            editingId = id;
            const form = document.getElementById('serviceForm');
            form.elements.serviceName.value = service.serviceName || '';
            form.elements.clientPrice.value = service.clientPrice || 0;
            form.elements.doulaPayout.value = service.doulaPayout || 0;
            form.elements.agencyProfit.value = service.agencyProfit || 0;
            
            openModal('serviceModal');
        }
        
// --- PAYCHECKS ---

        // Helper to get current ISO Week Number
        function getCurrentWeekNumber() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function renderPaychecks() {
            const container = document.getElementById('paychecksTableBody');
            const weekFilter = document.getElementById('paycheckWeekFilter').value;
            const doulaFilter = document.getElementById('paycheckDoulaFilter').value;

            const filteredPaychecks = paychecks.filter(p => {
                const weekMatch = !weekFilter || p.weekNumber === weekFilter;
                const doulaMatch = !doulaFilter || p.doula === doulaFilter;
                return weekMatch && doulaMatch;
            });
            
            container.innerHTML = filteredPaychecks.map(p => {
                const bookingsList = (p.bookingIds || []).map(bid => {
                    const booking = bookings.find(b => b.id === bid);
                    return booking ? `${escapeHtml(booking.clientName)} (#${escapeHtml(booking.invoiceNumber || bid)})` : `#${bid}`;
                }).join(', ') || 'N/A';

                const servicesList = (p.serviceDetails || []).map(sd => `
                    <li class="paycheck-service-row">
                        <span>${escapeHtml(sd.name)} <small style="color:#999;">x${sd.quantity || 1}${sd.hours ? ` (${sd.hours}hrs)` : ''}</small></span>
                        <span class="paycheck-amount">${(sd.amount || 0).toFixed(2)}</span>
                    </li>
                `).join('');

                return `
                    <tr>
                        <td data-label="Week">Week ${escapeHtml(p.weekNumber)}</td>
                        <td data-label="Doula" style="font-weight:600; color:var(--primary);">${escapeHtml(p.doula)}</td>
                        <td data-label="Date">${escapeHtml(p.invoiceDate)}</td>
                        <td data-label="Bookings" style="font-size: 0.9em;">${bookingsList}</td>
                        <td data-label="Services">
                            <ul class="paycheck-service-list">
                                ${servicesList || '<li style="color:#999;">No services</li>'}
                            </ul>
                        </td>
                        <td data-label="Total" style="font-weight:bold;">${Number(p.total || 0).toFixed(2)}</td>
                        <td class="action-btns">
                            <button class="btn btn-small btn-edit" onclick="editPaycheck(${p.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteItem('paycheck', ${p.id})">Delete</button>
                        </td>
                    </tr>
                `}).join('');

            renderPaycheckWeeklySummary();
        }

        function renderPaycheckWeeklySummary() {
            const container = document.getElementById('paycheckWeeklySummary');
            const weekFilter = document.getElementById('paycheckWeekFilter').value;
            
            if (!weekFilter) {
                container.innerHTML = '<p style="color: #999;">Select a week to see summary</p>';
                return;
            }

            const weekPaychecks = paychecks.filter(p => p.weekNumber === weekFilter);
            
            if (weekPaychecks.length === 0) {
                container.innerHTML = '<p style="color: #999;">No paychecks for this week</p>';
                return;
            }

            const totalPayout = weekPaychecks.reduce((sum, p) => sum + Number(p.total || 0), 0);
            const totalDoulas = new Set(weekPaychecks.map(p => p.doula)).size;

            container.innerHTML = `
                <div class="stat-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-label">Paychecks</div>
                        <div class="stat-value">${weekPaychecks.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Doulas Paid</div>
                        <div class="stat-value">${totalDoulas}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Payout</div>
                        <div class="stat-value">${totalPayout.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }

        function updatePaycheckWeekFilter() {
            const select = document.getElementById('paycheckWeekFilter');
            const weeks = [...new Set(paychecks.map(p => p.weekNumber))].sort((a, b) => Number(b) - Number(a));
            const current = select.value;
            select.innerHTML = '<option value="">All Weeks</option>' + 
                weeks.map(w => `<option value="${escapeHtml(w)}">Week ${escapeHtml(w)}</option>`).join('');
            select.value = current;
        }

        function newPaycheck() {
            editingId = null;
            const form = document.getElementById('paycheckForm');
            
            if (form) {
                form.reset(); // Clear previous data
            }

            // Target by name attribute exactly as seen in your inspection screenshot
            const weekInput = document.querySelector('input[name="weekNumber"]');
            const dateInput = document.querySelector('input[name="invoiceDate"]');

            if (weekInput) {
                const currentWeek = getCurrentWeekNumber();
                weekInput.value = currentWeek;
                console.log("Week set to:", currentWeek);
            }

            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                console.log("Date set to:", today);
            }

            // Clear dynamic booking list
            const container = document.getElementById('paycheckBookingsContainer');
            if (container) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Select a doula to see their bookings</p>';
            }
            
            calculatePaycheckTotals();
            openModal('paycheckModal');
        }

        function loadDoulaBookings() {
            const doulaSelect = document.getElementById('paycheckDoula');
            const selectedDoula = doulaSelect.value;
            const container = document.getElementById('paycheckBookingsContainer');

            if (!selectedDoula) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Select a doula to see their bookings</p>';
                calculatePaycheckTotals();
                return;
            }

            const doulaBookings = bookings.filter(b => 
                b.assignedDoulas && b.assignedDoulas.includes(selectedDoula)
            );

            if (doulaBookings.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No bookings found for this doula</p>';
                calculatePaycheckTotals();
                return;
            }

            container.innerHTML = doulaBookings.map(b => {
                const bookingServicesHtml = (b.serviceDetails || []).map(sd => {
                    const isHourly = isHourlyService(sd.name);
                    const bookedHours = sd.hours || 1;
                    
                    const paidHours = paychecks.reduce((total, paycheck) => {
                        if (!paycheck.bookingIds || !paycheck.bookingIds.includes(b.id)) return total;
                        const paidService = (paycheck.serviceDetails || []).find(s => s.name === sd.name);
                        return paidService && paidService.hours ? total + paidService.hours : total;
                    }, 0);
                    
                    const remainingHours = bookedHours - paidHours;
                    
                    if (isHourly && remainingHours <= 0) {
                        return `
                            <div class="booking-service-item" style="opacity: 0.5;">
                                <input type="checkbox" disabled>
                                <span>${escapeHtml(sd.name)} - <em style="color: #999;">Fully paid</em></span>
                            </div>
                        `;
                    }
                    
                    const maxHours = isHourly ? remainingHours : bookedHours;
                    
                    let hoursInput = '';
                    if (isHourly) {
                        hoursInput = `
                            <label style="margin: 0; font-size: 0.9em;">Hours:</label>
                            <input type="number" class="booking-service-hours" 
                                   onchange="calculatePaycheckTotals()"
                                   oninput="validateHoursInput(this); calculatePaycheckTotals()"
                                   data-booking="${b.id}" 
                                   data-service="${escapeHtml(sd.name)}"
                                   data-max="${maxHours}"
                                   min="0.5" max="${maxHours}" step="0.5" value="${maxHours}">
                            <span style="font-size: 0.85em; color: #999;">/ ${bookedHours} booked${paidHours > 0 ? ` (${paidHours} paid)` : ''}</span>
                        `;
                    }

                    return `
                        <div class="booking-service-item">
                            <input type="checkbox" 
                                   class="service-checkbox" 
                                   onchange="handleServiceCheckboxChange(this)"
                                   data-booking="${b.id}" 
                                   data-service="${escapeHtml(sd.name)}"
                                   data-hourly="${isHourly}"
                                   data-max-hours="${maxHours}">
                            <span>${escapeHtml(sd.name)}</span>
                            ${hoursInput}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="booking-item">
                        <div class="booking-header" onclick="toggleBookingServices(${b.id})">
                            <span class="booking-expand-icon" id="expand-icon-${b.id}"></span>
                            <strong>${escapeHtml(b.clientName)}</strong>
                            <span style="font-size: 0.9em; color: #666;">
                                Invoice: ${escapeHtml(b.invoiceNumber || 'N/A')}
                            </span>
                        </div>
                        <div class="booking-services-container" id="services-${b.id}">
                            ${bookingServicesHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            calculatePaycheckTotals();
        }

        function handleServiceCheckboxChange(checkbox) {
            const isHourly = checkbox.getAttribute('data-hourly') === 'true';
            
            if (isHourly && checkbox.checked) {
                const bookingId = checkbox.getAttribute('data-booking');
                const serviceName = checkbox.getAttribute('data-service');
                const hoursInput = document.querySelector(
                    `.booking-service-hours[data-booking="${bookingId}"][data-service="${serviceName}"]`
                );
                if (hoursInput) {
                    const maxHours = parseFloat(hoursInput.getAttribute('data-max'));
                    hoursInput.value = maxHours;
                }
            }
            calculatePaycheckTotals();
        }

        function toggleBookingServices(bookingId) {
            const servicesContainer = document.getElementById(`services-${bookingId}`);
            const expandIcon = document.getElementById(`expand-icon-${bookingId}`);
            
            if (servicesContainer && expandIcon) {
                servicesContainer.classList.toggle('expanded');
                expandIcon.classList.toggle('expanded');
            }
        }

        function validateHoursInput(input) {
            const max = parseFloat(input.getAttribute('data-max'));
            let value = parseFloat(input.value);
            
            if (value > max) {
                input.value = max;
                alert(`Cannot pay for more hours than booked. Maximum: ${max} hours`);
            }
            if (value < 0.5 && value > 0) {
                input.value = 0.5;
            }
        }

        function calculatePaycheckTotals() {
            let subtotal = 0;
            const selectedCheckboxes = document.querySelectorAll('.service-checkbox:checked');
            
            selectedCheckboxes.forEach(checkbox => {
                const bookingId = Number(checkbox.getAttribute('data-booking'));
                const serviceName = checkbox.getAttribute('data-service');
                const isHourly = checkbox.getAttribute('data-hourly') === 'true';
                
                const service = services.find(s => s.serviceName === serviceName);
                
                if (service) {
                    let hours = 1;
                    if (isHourly) {
                        const hoursInput = document.querySelector(
                            `.booking-service-hours[data-booking="${bookingId}"][data-service="${serviceName}"]`
                        );
                        hours = hoursInput ? (parseFloat(hoursInput.value) || 0) : 1;
                    }
                    subtotal += (service.doulaPayout * hours);
                }
            });

            const hstToggle = document.getElementById('hstToggle');
            const includeHst = hstToggle && hstToggle.checked;
            const hst = includeHst ? (subtotal * 0.13) : 0;
            const total = subtotal + hst;
            
            document.getElementById('paycheckSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('paycheckHst').textContent = hst.toFixed(2);
            document.getElementById('paycheckTotal').textContent = total.toFixed(2);
            
            const hstRow = document.getElementById('paycheckHstRow');
            if (hstRow) {
                hstRow.style.display = includeHst ? 'flex' : 'none';
            }
        }
        
        function editPaycheck(id) {
            const paycheck = paychecks.find(p => p.id === id);
            if (!paycheck) return;

            editingId = id;
            const form = document.getElementById('paycheckForm');
            
            form.elements.doula.value = paycheck.doula || '';
            form.elements.weekNumber.value = paycheck.weekNumber || '';
            form.elements.invoiceDate.value = paycheck.invoiceDate || '';

            const hstToggle = document.getElementById('hstToggle');
            if (hstToggle) {
                hstToggle.checked = !!(paycheck.hst && paycheck.hst > 0);
            }

            loadDoulaBookings();

            setTimeout(() => {
                if (paycheck.serviceDetails && paycheck.serviceDetails.length > 0) {
                    paycheck.serviceDetails.forEach(sd => {
                        const matchingCheckboxes = document.querySelectorAll(`.service-checkbox[data-service="${sd.name}"]`);
                        
                        matchingCheckboxes.forEach(checkbox => {
                            const bookingId = Number(checkbox.getAttribute('data-booking'));
                            
                            if (paycheck.bookingIds && paycheck.bookingIds.includes(bookingId)) {
                                checkbox.checked = true;
                                if (sd.hours) {
                                    const hoursInput = document.querySelector(
                                        `.booking-service-hours[data-booking="${bookingId}"][data-service="${sd.name}"]`
                                    );
                                    if (hoursInput) hoursInput.value = sd.hours;
                                }
                            }
                        });
                    });
                }
                calculatePaycheckTotals();
            }, 100);

            openModal('paycheckModal');
        }

        // --- SUMMARY REPORTS ---

        function renderSummary() {
            const statsContainer = document.getElementById('summaryStats');
            const bookingsCompleted = bookings.filter(b => b.bookingStatus === 'Archive').length;
            const totalDoulas = doulas.length;
            const totalProfit = bookings.reduce((sum, b) => {
                if (!b.serviceDetails) return sum;
                return sum + b.serviceDetails.reduce((bSum, sd) => {
                    const service = services.find(s => s.serviceName === sd.name);
                    if (service) {
                        const hours = sd.hours || 1;
                        return bSum + (service.agencyProfit * hours);
                    }
                    return bSum;
                }, 0);
            }, 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Doulas</div>
                    <div class="stat-value">${totalDoulas}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed Bookings</div>
                    <div class="stat-value">${bookingsCompleted}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Estimated Profit (YTD)</div>
                    <div class="stat-value">${totalProfit.toFixed(2)}</div>
                </div>
            `;
            
            const reportWeekInput = document.getElementById('reportWeek');
            const currentWeek = reportWeekInput.value || getDefaultWeek();
            
            if (!reportWeekInput.value) {
                reportWeekInput.value = currentWeek;
            }

            const weekNumber = currentWeek.substring(currentWeek.indexOf('W') + 1);
            
            const weeklyPaychecks = paychecks.filter(p => p.weekNumber === weekNumber);
            const serviceCounts = {};

            weeklyPaychecks.forEach(p => {
                (p.serviceDetails || []).forEach(sd => {
                    const sName = sd.name;
                    const quantity = sd.quantity || 1;
                    const hours = sd.hours || 1;
                    
                    if (!serviceCounts[sName]) {
                        serviceCounts[sName] = { qty: 0, amt: 0 };
                    }
                    serviceCounts[sName].qty += quantity;
                    
                    const serviceConfig = services.find(s => s.serviceName === sName);
                    if (serviceConfig) {
                        serviceCounts[sName].amt += serviceConfig.clientPrice * hours;
                    }
                });
            });

            const container = document.getElementById('servicesReportContainer');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Total Quantity</th>
                            <th>Total Client Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(serviceCounts).forEach(sName => {
                html += `<tr> 
                    <td>${sName}</td> 
                    <td>${serviceCounts[sName].qty}</td> 
                    <td>${serviceCounts[sName].amt.toFixed(2)}</td> 
                </tr>`;
            });

            if (Object.keys(serviceCounts).length === 0) {
                html += `<tr><td colspan="3" style="text-align:center;">No services recorded this week.</td></tr>`;
            }
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function getDefaultWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const weekNo = getWeekNumber(now);
            return `${year}-W${weekNo}`;
        }
        
        // --- SAVE / EDIT / DELETE LOGIC ---

        async function saveBooking(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const selectedDoulas = Array.from(document.querySelectorAll('#bookingDoulasContainer input:checked'))
                .map(cb => cb.getAttribute('data-name'))
                .filter(Boolean);
            
            const selectedServices = [];
            document.querySelectorAll('#bookingServicesContainer .service-checkbox:checked').forEach(cb => {
                const serviceName = cb.getAttribute('data-name');
                const isHourly = cb.getAttribute('data-hourly') === 'true';
                const parent = cb.parentElement.parentElement;
                
                let hours = undefined;
                if (isHourly) {
                    const hoursInput = parent.querySelector('.service-hours');
                    hours = hoursInput ? Number(hoursInput.value) || 1 : 1;
                }
                
                selectedServices.push({ 
                    name: serviceName, 
                    hours: hours
                });
            });
            
            const booking = {
                clientName: formData.get('clientName'),
                invoiceNumber: formData.get('invoiceNumber'),
                dueDate: formData.get('dueDate'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                assignedDoulas: selectedDoulas.join(', '),
                bookingStatus: formData.get('bookingStatus'),
                paymentStatus: formData.get('paymentStatus'),
                serviceDetails: selectedServices,
                services: selectedServices.map(s => s.name).join(', ')
            };

            try {
                if (editingId) {
                    booking.id = editingId;
                    const idx = bookings.findIndex(b => b.id === editingId);
                    if(idx !== -1) bookings[idx] = { ...bookings[idx], ...booking };
                    await apiPut(`/api/bookings/${editingId}`, booking);
                } else {
                    const created = await apiPost('/api/bookings', booking);
                    bookings.push(created);
                }
                renderBookings();
                closeModal('bookingModal');
            } catch (error) {
                console.error("Error saving booking:", error);
                alert('Failed to save booking. Check the server connection and ensure all required fields are filled.');
            }
        }

        async function saveDoula(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const doula = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                sinNumber: formData.get('sinNumber'),
                address: formData.get('address'),
                servicesOffered: formData.get('servicesOffered'),
                cprCertified: formData.get('cprCertified') === 'on',
                cprExpiry: formData.get('cprExpiry'),
                policeCheck: formData.get('policeCheck') === 'on',
                insuranceUpToDate: formData.get('insuranceUpToDate') === 'on'
            };
            
            try {
                if (editingId) {
                    doula.id = editingId;
                    const idx = doulas.findIndex(d => d.id === editingId);
                    if(idx !== -1) doulas[idx] = { ...doulas[idx], ...doula };
                    await apiPut(`/api/doulas/${editingId}`, doula);
                } else {
                    const created = await apiPost('/api/doulas', doula);
                    doulas.push(created);
                }
                renderDoulas();
                updateDoulaDropdowns();
                closeModal('doulaModal');
            } catch (error) {
                console.error("Error saving doula:", error);
                alert('Failed to save doula. Check the server connection and ensure all required fields are filled.');
            }
        }

        async function saveService(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const service = {
                serviceName: formData.get('serviceName'),
                clientPrice: Number(formData.get('clientPrice')),
                doulaPayout: Number(formData.get('doulaPayout')),
                agencyProfit: Number(formData.get('agencyProfit'))
            };
            
            try {
                if (editingId) {
                    service.id = editingId;
                    const idx = services.findIndex(s => s.id === editingId);
                    if(idx !== -1) services[idx] = { ...services[idx], ...service };
                    await apiPut(`/api/services/${editingId}`, service);
                } else {
                    const created = await apiPost('/api/services', service);
                    services.push(created);
                }
                renderServices();
                renderBookingServicesCheckboxes();
                closeModal('serviceModal');
            } catch (error) {
                console.error("Error saving service:", error);
                alert('Failed to save service. Check the server connection and ensure all required fields are filled.');
            }
        }
        
        async function savePaycheck(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked'));
            
            if (selectedServices.length === 0) {
                alert("Please select at least one service to pay for.");
                return;
            }

            const bookingIds = new Set();
            let subtotal = 0;
            const serviceDetails = [];

            selectedServices.forEach(checkbox => {
                const bookingId = Number(checkbox.getAttribute('data-booking'));
                const serviceName = checkbox.getAttribute('data-service');
                const isHourly = checkbox.getAttribute('data-hourly') === 'true';
                
                bookingIds.add(bookingId);
                
                const service = services.find(s => s.serviceName === serviceName);
                if (service) {
                    let hours = 1;
                    if (isHourly) {
                        const hoursInput = document.querySelector(
                            `.booking-service-hours[data-booking="${bookingId}"][data-service="${serviceName}"]`
                        );
                        hours = hoursInput ? Number(hoursInput.value) || 1 : 1;
                    }
                    
                    const amount = service.doulaPayout * hours;
                    
                    serviceDetails.push({ 
                        name: serviceName, 
                        quantity: 1,
                        hours: isHourly ? hours : undefined,
                        amount: amount 
                    });
                    subtotal += amount;
                }
            });

            const hstToggle = document.getElementById('hstToggle');
            const includeHst = hstToggle && hstToggle.checked;
            const hst = includeHst ? +(subtotal * 0.13).toFixed(2) : 0;

            const paycheck = {
                doula: formData.get('doula'),
                weekNumber: formData.get('weekNumber'),
                invoiceDate: formData.get('invoiceDate'),
                bookingIds: Array.from(bookingIds),
                serviceDetails: serviceDetails,
                subtotal: +subtotal.toFixed(2),
                hst: hst,
                total: +(subtotal + hst).toFixed(2)
            };
            
            try {
                if (editingId) {
                    paycheck.id = editingId;
                    const idx = paychecks.findIndex(p => p.id === editingId);
                    if(idx !== -1) paychecks[idx] = { ...paychecks[idx], ...paycheck };
                    await apiPut(`/api/paychecks/${editingId}`, paycheck);
                } else {
                    const created = await apiPost('/api/paychecks', paycheck);
                    paychecks.push(created);
                }
                renderPaychecks();
                updatePaycheckWeekFilter();
                closeModal('paycheckModal');
                renderSummary();
            } catch (error) {
                console.error("Error saving paycheck:", error);
                alert('Failed to save paycheck. Check the server connection and ensure all required fields are filled.');
            }
        }

        function editBooking(id) {
            closeModal('detailsModal');
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            editingId = id;
            const form = document.getElementById('bookingForm');
            
            form.elements.clientName.value = booking.clientName || '';
            form.elements.invoiceNumber.value = booking.invoiceNumber || '';
            form.elements.dueDate.value = booking.dueDate || '';
            form.elements.phone.value = booking.phone || '';
            form.elements.email.value = booking.email || '';
            form.elements.bookingStatus.value = booking.bookingStatus || 'Current';
            form.elements.paymentStatus.value = booking.paymentStatus || 'Deposit';

            openModal('bookingModal');
        }

        function editDoula(id) {
            closeModal('detailsModal');
            const doula = doulas.find(d => d.id === id);
            if (!doula) return;

            editingId = id;
            const form = document.getElementById('doulaForm');
            form.elements.name.value = doula.name || '';
            form.elements.phone.value = doula.phone || '';
            form.elements.email.value = doula.email || '';
            form.elements.sinNumber.value = doula.sinNumber || '';
            form.elements.address.value = doula.address || '';
            form.elements.servicesOffered.value = doula.servicesOffered || '';
            form.elements.cprCertified.checked = doula.cprCertified || false;
            form.elements.cprExpiry.value = doula.cprExpiry || '';
            form.elements.policeCheck.checked = doula.policeCheck || false;
            form.elements.insuranceUpToDate.checked = doula.insuranceUpToDate || false;

            openModal('doulaModal');
        }

        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                await apiDelete(`/api/${type}s/${id}`);
                
                if (type === 'booking') {
                    bookings = bookings.filter(b => b.id !== id);
                    renderBookings();
                } else if (type === 'doula') {
                    doulas = doulas.filter(d => d.id !== id);
                    renderDoulas();
                    updateDoulaDropdowns();
                } else if (type === 'service') {
                    services = services.filter(s => s.id !== id);
                    renderServices();
                    renderBookingServicesCheckboxes();
                } else if (type === 'paycheck') {
                    paychecks = paychecks.filter(p => p.id !== id);
                    renderPaychecks();
                    updatePaycheckWeekFilter();
                    renderSummary();
                }
                
                closeModal('detailsModal');
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully.`);
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                alert(`Failed to delete ${type}. Check the server connection.`);
            }
        }
        
        // --- MODAL / HELPER FUNCTIONS ---

        function isHourlyService(serviceName) {
            return serviceName.toLowerCase().includes('/ hr') || 
                   serviceName.toLowerCase().includes('per hour') ||
                   serviceName.toLowerCase().includes('hourly');
        }

        function renderBookingServicesCheckboxes() {
            const container = document.getElementById('bookingServicesContainer');
            if (!container) return;
            
            const existingBooking = editingId ? bookings.find(b => b.id === editingId) : null;
            const existingServices = existingBooking?.serviceDetails || [];
            
            container.innerHTML = services.map(s => {
                const existing = existingServices.find(es => es.name === s.serviceName);
                const isChecked = existing ? 'checked' : '';
                const hours = existing?.hours || 1;
                const showHours = isHourlyService(s.serviceName);

                let hoursInput = '';
                if (showHours) {
                    hoursInput = `
                        <div class="service-hours-input" style="display: ${isChecked ? 'flex' : 'none'};">
                            <label style="margin: 0;">Hours:</label>
                            <input type="number" class="service-hours" min="0.5" step="0.5" value="${hours}">
                        </div>
                    `;
                }

                return `
                    <div style="margin-bottom: 10px;">
                        <label>
                            <input type="checkbox" class="service-checkbox" data-name="${escapeHtml(s.serviceName)}" data-hourly="${showHours}" value="${s.id}" ${isChecked} onchange="toggleServiceHours(this)">
                            <span>${escapeHtml(s.serviceName)}</span>
                        </label>
                        ${hoursInput}
                    </div>
                `;
            }).join('');
        }

        function toggleServiceHours(checkbox) {
            const isHourly = checkbox.getAttribute('data-hourly') === 'true';
            if (!isHourly) return;
            
            const parent = checkbox.parentElement.parentElement;
            const hoursDiv = parent.querySelector('.service-hours-input');
            
            if (hoursDiv) {
                hoursDiv.style.display = checkbox.checked ? 'flex' : 'none';
            }
        }

        function renderBookingDoulasCheckboxes() {
            const container = document.getElementById('bookingDoulasContainer');
            if (!container) return;
            
            const existingBooking = editingId ? bookings.find(b => b.id === editingId) : null;
            const existingDoulas = existingBooking?.assignedDoulas?.split(', ') || [];
            
            container.innerHTML = doulas.map(d => {
                const isChecked = existingDoulas.includes(d.name) ? 'checked' : '';
                return `
                    <label>
                        <input type="checkbox" data-name="${escapeHtml(d.name)}" value="${d.id}" ${isChecked}>
                        <span>${escapeHtml(d.name)}</span>
                    </label>
                `;
            }).join('');
        }

function openModal(modalId) {
            document.getElementById(modalId).classList.add('active'); 
            
            if (editingId === null) {
                const form = document.querySelector(`#${modalId} form`);
                if(form) form.reset();
            }

            if (modalId === 'bookingModal') {
                document.getElementById('bookingModalTitle').textContent = editingId ? 'Edit Booking' : 'New Booking';
                renderBookingServicesCheckboxes();
                renderBookingDoulasCheckboxes();
            } else if (modalId === 'doulaModal') {
                document.getElementById('doulaModalTitle').textContent = editingId ? 'Edit Doula' : 'Add Doula';
            } else if (modalId === 'serviceModal') {
                document.getElementById('serviceModalTitle').textContent = editingId ? 'Edit Service' : 'Add Service';
            } else if (modalId === 'paycheckModal') {
                document.getElementById('paycheckModalTitle').textContent = editingId ? 'Edit Paycheck' : 'Generate Paycheck';
                
                if(editingId === null) {
                    // --- FIX STARTS HERE ---
                    // Set defaults AFTER the form.reset() above has finished
                    const weekInput = document.querySelector('input[name="weekNumber"]');
                    const dateInput = document.querySelector('input[name="invoiceDate"]');

                    if (weekInput) weekInput.value = getCurrentWeekNumber();
                    if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
                    // --- FIX ENDS HERE ---

                    document.getElementById('paycheckBookingsContainer').innerHTML = '<p style="color: #999; text-align: center;">Select a doula to see their bookings</p>';
                    const hstToggle = document.getElementById('hstToggle');
                    if (hstToggle) hstToggle.checked = false;
                    calculatePaycheckTotals();
                }
                
                // Add event delegation for dynamic checkboxes and inputs
                const container = document.getElementById('paycheckBookingsContainer');
                if (container) {
                    container.replaceWith(container.cloneNode(true));
                    const newContainer = document.getElementById('paycheckBookingsContainer');
                    
                    newContainer.addEventListener('change', function(e) {
                        if (e.target.classList.contains('service-checkbox')) {
                            setTimeout(() => {
                                handleServiceCheckboxChange(e.target);
                            }, 0);
                        }
                    });
                    
                    newContainer.addEventListener('input', function(e) {
                        if (e.target.classList.contains('booking-service-hours')) {
                            validateHoursInput(e.target);
                            setTimeout(() => {
                                calculatePaycheckTotals();
                            }, 0);
                        }
                    });
                }
            }
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingId = null;
        }

        function showMainApp() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('mainAppContainer').style.display = 'block';
            initApp();
        }
        
        function updateDoulaDropdowns() {
            const selects = [document.getElementById('paycheckDoula'), document.getElementById('paycheckDoulaFilter')];
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                
                if (select.id === 'paycheckDoulaFilter') {
                     select.innerHTML = '<option value="">All Doulas</option>' + 
                        doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
                } else {
                     select.innerHTML = '<option value="">Select Doula</option>' + 
                        doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
                }
                
                select.value = currentValue;
            });
        }
        
        async function initApp() {
            try {
                const all = await apiGet('/api/all');
                bookings = all.bookings || [];
                doulas = all.doulas || [];
                services = all.services || [];
                paychecks = all.paychecks || [];

                renderBookings();
                renderDoulas();
                renderServices();
                renderPaychecks();
                updatePaycheckWeekFilter();
                updateDoulaDropdowns();
                renderSummary();
            } catch (err) {
                console.error('Load failed', err);
                alert('Could not load data. Check server.');
            }
        }

        window.addEventListener('load', () => {
            if (localStorage.getItem(AUTH_KEY) === 'true') {
                showMainApp();
            }
        });

    </script>
</body>
</html>