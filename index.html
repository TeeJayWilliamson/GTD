<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greater Toronto Doulas - Management System</title>
    <style>
        :root {
            --primary: #8b7355;
            --secondary: #d4a574;
            --bg: #f8f5f2;
            --white: #ffffff;
            --text: #444;
            --gray-light: #e8e0d8;
            --danger: #c17b5f;
            --success: #6b8e23;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--secondary);
        }
        h1 { color: var(--primary); font-weight: 300; letter-spacing: 1px; margin-bottom: 5px;}
        .tagline { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; }

        /* --- Navigation --- */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--primary);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-btn.active, .tab-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(139, 115, 85, 0.2);
        }

        /* --- Tab Content --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary); font-weight: 300; margin-bottom: 20px; }

        /* --- Controls --- */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input, .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .search-input { width: 100%; max-width: 300px; }

        /* --- List Views (Bookings & Doulas) --- */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .list-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-color: var(--secondary);
        }
        .list-item-name {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--primary);
        }
        .list-item-icon { color: var(--secondary); font-size: 1.2em; }

        /* --- Tables (Services & Paychecks) --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 10px;
        }
        th {
            text-align: left;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        tr {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        td { padding: 15px; border-top: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); vertical-align: middle; }
        td:first-child { border-left: 1px solid var(--gray-light); border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: 500; color: var(--primary); }
        td:last-child { border-right: 1px solid var(--gray-light); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* Paycheck Service styling */
        .paycheck-service-list { list-style: none; font-size: 0.9em; }
        .paycheck-service-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dashed #eee; }
        .paycheck-service-row:last-child { border-bottom: none; }
        .paycheck-amount { font-weight: 600; color: #666; margin-left: 10px; }

        /* --- Buttons --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: background 0.2s;
        }
        .btn:hover { background: #6d5942; }
        
        .btn-secondary { background: var(--gray-light); color: var(--primary); }
        .btn-small { padding: 6px 12px; font-size: 0.8em; margin-right: 5px; border-radius: 4px; }
        .btn-edit { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-add-line { background: var(--secondary); margin-top: 10px; width: 100%; }
        .btn-remove-line { background: var(--danger); padding: 5px 10px; margin-left: 10px; }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px); align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fefefe; padding: 30px; border-radius: 12px;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--gray-light); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 2rem; cursor: pointer; border: none; background: none; color: #999; line-height: 1; }
        
        /* Details View in Modal */
        .detail-row { display: flex; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
        .detail-label { width: 120px; font-weight: 600; color: #888; flex-shrink: 0; }
        .detail-value { color: #333; flex-grow: 1; }
        .detail-actions { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--gray-light); text-align: right; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        input, select, textarea { padding: 12px; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1em; background: #fafafa; width: 100%; }
        
#bookingServicesContainer label {
    display: flex;
    align-items: center; /* vertically center */
    gap: 8px;
    margin-bottom: 0;
}

/* Nudge the text slightly up */
#bookingServicesContainer label span {
    display: inline-block;
    transform: translateY(-1px); /* adjust as needed, -1px or -2px */
}

/* Make sure checkbox itself is consistent size */
#bookingServicesContainer input[type="checkbox"],
#bookingServicesContainer input[type="radio"] {
    width: 18px;
    height: 18px;
    margin: 0;
    flex-shrink: 0;
}



        /* Login Form Styles - Ensure this modal is always active on load until login */
        .login-form-container {
            padding: 30px;
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-form-container h2 {
            color: var(--primary);
            margin-bottom: 25px;
        }
        .login-form-container .form-group {
            margin-bottom: 20px;
        }
        .login-form-container input[type="text"], 
        .login-form-container input[type="password"] {
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            width: 100%;
        }
        .login-form-container .btn {
            width: 100%;
            margin-top: 15px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .controls-bar { flex-direction: column-reverse; align-items: stretch; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid var(--gray-light); border-radius: 8px; padding: 10px; }
            td { border: none; padding: 8px 5px; display: flex; justify-content: space-between; text-align: right; }
            td::before { content: attr(data-label); font-weight: bold; color: #999; margin-right: 10px; text-align: left; }
            td:first-child { border-bottom: 1px solid #eee; margin-bottom: 10px; color: var(--primary); font-weight: bold; display: block; text-align: left;}
        }

        /* Summary Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); border: 1px solid var(--gray-light); padding: 25px; text-align: center; border-radius: 8px; }
        .stat-label { font-size: 0.85em; color: #999; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 2em; font-weight: 300; color: var(--primary); }
    </style>
</head>
<body>

    <div id="mainAppContainer" style="display: none;">
        <div class="container">
            <header style="position: relative;">
                <h1>Greater Toronto Doulas</h1>
                <p class="tagline">Management System</p>
                <button class="btn btn-secondary btn-small" style="position: absolute; top: 10px; right: 20px;" onclick="handleLogout()">Logout</button>
            </header>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('bookings', event)">Bookings</button>
                <button class="tab-btn" onclick="switchTab('doulas', event)">Doulas</button>
                <button class="tab-btn" onclick="switchTab('services', event)">Services</button>
                <button class="tab-btn" onclick="switchTab('paychecks', event)">Paychecks</button>
                <button class="tab-btn" onclick="switchTab('summary', event)">Reports</button>
            </div>

            <div id="bookings" class="tab-content active">
                <div class="controls-bar">
                    <h2>Client Bookings</h2>
                    <button class="btn" onclick="newBooking()">+ New Booking</button>
                </div>
                <div class="search-bar-wrapper" style="margin-bottom: 20px;">
                    <input type="text" class="search-input" placeholder="Search clients..." onkeyup="filterList('bookingsList', this.value)">
                </div>
                <div id="bookingsList" class="list-container">
                    </div>
            </div>

            <div id="doulas" class="tab-content">
                <div class="controls-bar">
                    <h2>Doula Directory</h2>
                    <button class="btn" onclick="newDoula()">+ Add Doula</button>
                </div>
                <div class="search-bar-wrapper" style="margin-bottom: 20px;">
                    <input type="text" class="search-input" placeholder="Search doulas..." onkeyup="filterList('doulasList', this.value)">
                </div>
                <div id="doulasList" class="list-container">
                    </div>
            </div>

            <div id="services" class="tab-content">
                <div class="controls-bar">
                    <h2>Services & Pricing</h2>
                    <button class="btn" onclick="newService()">+ Add Service</button>
                </div>
                <table id="servicesTable">
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Client Price</th>
                            <th>Doula Payout</th>
                            <th>Agency Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody"></tbody>
                </table>
            </div>

            <div id="paychecks" class="tab-content">
                <div class="controls-bar">
                    <h2>Paychecks</h2>
                    <button class="btn" onclick="newPaycheck()">+ Generate</button>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <label style="margin:0;">Filter by Week:</label>
                    <select id="paycheckWeekFilter" class="filter-select" onchange="renderPaychecks()">
                        <option value="all">Show All Weeks</option>
                        </select>
                </div>

                <table id="paychecksTable">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Doula</th>
                            <th>Invoice Date</th>
                            <th style="width: 35%;">Services Breakdown</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paychecksTableBody"></tbody>
                </table>
            </div>

            <div id="summary" class="tab-content">
                <h2>Summary Reports</h2>
                
                <div class="controls-bar" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display:flex; gap: 15px; align-items: center; width: 100%;">
                        <div>
                            <label>Report Type:</label>
                            <select id="summaryType" class="filter-select" onchange="renderSummary()">
                                <option value="ytd">Year to Date Overview</option>
                                <option value="weekly">Weekly Report</option>
                            </select>
                        </div>
                        <div id="summaryWeekSelectWrapper" style="display:none;">
                            <label>Select Week:</label>
                            <select id="summaryWeekSelect" class="filter-select" onchange="renderSummary()">
                                </select>
                        </div>
                    </div>
                </div>

                <div id="summaryContent"></div>
            </div>
        </div>
    </div>
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsTitle">Details</h2>
                <button class="close-btn" onclick="closeModal('detailsModal')">&times;</button>
            </div>
            <div id="detailsBody"></div>
            <div id="detailsActions" class="detail-actions">
                </div>
        </div>
    </div>

    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookingModalTitle">New Booking</h2>
                <button class="close-btn" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Assigned Doula</label>
                        <select name="assignedDoula" id="assignedDoula">
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Current">Current</option>
                            <option value="Completed">Completed</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paid</label>
                        <select name="paid">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services *</label>
<div class="multi-select-wrapper" id="bookingServicesContainer" style="border:1px solid #ddd; padding:15px 5px 5px 5px; max-height:100px; overflow-y:auto;"></div>                    </div>
                </div>
                <button type="submit" class="btn">Save Booking</button>
            </form>
        </div>
    </div>

    <div id="doulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="doulaModalTitle">Add Doula</h2>
                <button class="close-btn" onclick="closeModal('doulaModal')">&times;</button>
            </div>
            <form id="doulaForm" onsubmit="saveDoula(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services Offered</label>
                        <textarea name="servicesOffered" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn">Save Doula</button>
            </form>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Add Service</h2>
                <button class="close-btn" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Name *</label>
                        <input type="text" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Price *</label>
                        <input type="number" name="clientPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Doula Payout *</label>
                        <input type="number" name="doulaPayout" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn">Save Service</button>
            </form>
        </div>
    </div>

    <div id="paycheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paycheckModalTitle">Generate Paycheck</h2>
                <button class="close-btn" onclick="closeModal('paycheckModal')">&times;</button>
            </div>
            <form id="paycheckForm" onsubmit="savePaycheck(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Doula *</label>
                        <select name="doula" id="paycheckDoula" required>
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="number" name="weekNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" name="invoiceDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Services</label>
                    <div id="paycheckServicesContainer"></div>
                    <button type="button" class="btn btn-add-line" onclick="addPaycheckServiceLine()">+ Add Service</button>
                </div>
                <button type="submit" class="btn">Generate Paycheck</button>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal active">
        <div class="login-form-container">
            <div class="modal-header">
                <h2>System Login</h2>
                </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
                <p id="loginMessage" style="color: var(--danger); margin-top: 10px;"></p>
            </form>
        </div>
    </div>
    <script>
const API_BASE = 'https://gtd-1rkv.onrender.com'; // Change to '' if hosted on same server
const AUTH_KEY = 'gtd_admin_logged_in';
const STATIC_USERNAME = 'GTDAdmin';
const STATIC_PASSWORD = 'Doula@123'; // NOTE: This is client-side and not secure.

let bookings = [];
let doulas = [];
let services = [];
let paychecks = [];
let editingId = null;

// --- UTILS ---
function formatPhone(str) {
    if(!str) return '';
    const cleaned = ('' + str).replace(/\D/g, '');
    const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
    if (match) {
        return '(' + match[1] + ') ' + match[2] + '-' + match[3];
    }
    return str;
}

function escapeHtml(unsafe) {
    if (unsafe === undefined || unsafe === null) return '';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// --- API ---
async function apiGet(path){
  const res = await fetch(API_BASE + path);
  if (!res.ok) throw new Error('API error');
  return res.json();
}
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API post error');
  return res.json();
}
async function apiDelete(path){
  const res = await fetch(API_BASE + path, { method: 'DELETE' });
  if (!res.ok) throw new Error('API delete error');
  return res.json();
}
async function apiPut(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API put error');
  return res.json();
}

// --- UI LOGIC ---

function switchTab(tabName, e) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if (e && e.target) e.target.classList.add('active');
  
  if (tabName === 'summary') {
    renderSummary();
  }
}

function filterList(containerId, searchText) {
    const container = document.getElementById(containerId);
    const items = container.getElementsByClassName("list-item");
    const filter = searchText.toLowerCase();

    for (let i = 0; i < items.length; i++) {
        let text = items[i].textContent.toLowerCase();
        items[i].style.display = text.includes(filter) ? "flex" : "none";
    }
}

// Wrapper functions for new items
function newBooking() { editingId = null; openModal('bookingModal'); }
function newDoula() { editingId = null; openModal('doulaModal'); }
function newService() { editingId = null; openModal('serviceModal'); }
function newPaycheck() { editingId = null; openModal('paycheckModal'); }

// MODIFIED: Logic updated to only reset form if not editing, and set title dynamically
function openModal(modalId) { 
  document.getElementById(modalId).classList.add('active');
  
  // Clear forms ONLY if we are NOT in an edit flow (editingId is null)
  if (editingId === null) {
      const form = document.querySelector(`#${modalId} form`);
      if(form) form.reset();
  }

  if (modalId === 'bookingModal') {
    document.getElementById('bookingModalTitle').textContent = editingId ? 'Edit Booking' : 'New Booking';
    renderBookingServicesCheckboxes();
  } else if (modalId === 'doulaModal') {
    document.getElementById('doulaModalTitle').textContent = editingId ? 'Edit Doula' : 'Add Doula';
  } else if (modalId === 'serviceModal') {
    document.getElementById('serviceModalTitle').textContent = editingId ? 'Edit Service' : 'Add Service';
  } else if (modalId === 'paycheckModal') {
    document.getElementById('paycheckModalTitle').textContent = editingId ? 'Edit Paycheck' : 'Generate Paycheck';
    // Only clear and add line for *new* paycheck
    if(editingId === null) {
        document.getElementById('paycheckServicesContainer').innerHTML = '';
        addPaycheckServiceLine();
    }
  }
}

function closeModal(modalId) { 
  document.getElementById(modalId).classList.remove('active'); 
  editingId = null;
}

// NEW: Function to show the main app
function showMainApp() {
    document.getElementById('loginModal').classList.remove('active');
    document.getElementById('mainAppContainer').style.display = 'block';
    initApp(); // Load data once logged in
}

// NEW: Function to handle Logout
function handleLogout() {
    localStorage.removeItem(AUTH_KEY);
    document.getElementById('mainAppContainer').style.display = 'none';
    document.getElementById('loginModal').classList.add('active');
    document.getElementById('loginMessage').textContent = 'Logged out successfully.';
    document.getElementById('loginMessage').style.color = 'var(--success)';
}

// NEW: Static client-side login implementation
function handleLogin(e) {
    e.preventDefault();
    const username = e.target.username.value;
    const password = e.target.password.value;
    const msgElement = document.getElementById('loginMessage');
    
    // --- STATIC LOGIN CHECK ---
    if (username === STATIC_USERNAME && password === STATIC_PASSWORD) {
        msgElement.textContent = 'Login successful! Access granted.';
        msgElement.style.color = 'var(--success)';
        localStorage.setItem(AUTH_KEY, 'true'); // Simulate session
        setTimeout(() => {
            showMainApp();
        }, 500);
    } else {
        msgElement.textContent = 'Invalid username or password.';
        msgElement.style.color = 'var(--danger)';
    }
}


// --- BOOKINGS (Card View + Details Modal) ---

function renderBookings() {
    const container = document.getElementById('bookingsList');
    if (!bookings || bookings.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No bookings found.</div>';
        return;
    }
    
    // Sort slightly by ID (newest last) or you could do by date
    container.innerHTML = bookings.map(b => `
        <div class="list-item" onclick="viewBookingDetails(${b.id})">
            <div class="list-item-name">${escapeHtml(b.clientName)}</div>
            <div class="list-item-icon">Details &rsaquo;</div>
        </div>
    `).join('');
}

function viewBookingDetails(id) {
    const b = bookings.find(item => item.id === id);
    if (!b) return;

    const modal = document.getElementById('detailsModal');
    const title = document.getElementById('detailsTitle');
    const body = document.getElementById('detailsBody');
    const actions = document.getElementById('detailsActions');

    title.textContent = b.clientName;
    body.innerHTML = `
        <div class="detail-row"><span class="detail-label">Due Date:</span><span class="detail-value">${escapeHtml(b.dueDate || 'N/A')}</span></div>
        <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(b.phone)}">${formatPhone(b.phone)}</a></span></div>
        <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(b.email)}">${escapeHtml(b.email)}</a></span></div>
        <div class="detail-row"><span class="detail-label">Doula:</span><span class="detail-value">${escapeHtml(b.assignedDoula || 'Unassigned')}</span></div>
        <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value">${escapeHtml(b.status)}</span></div>
        <div class="detail-row"><span class="detail-label">Paid:</span><span class="detail-value">${escapeHtml(b.paid)}</span></div>
        <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value">${escapeHtml(b.services)}</span></div>
    `;

    actions.innerHTML = `
        <button class="btn btn-edit" onclick="editBooking(${b.id})">Edit Booking</button>
        <button class="btn btn-danger" onclick="deleteItem('booking', ${b.id})">Delete</button>
    `;

    modal.classList.add('active');
}

// --- DOULAS (Card View + Details Modal) ---

function renderDoulas() {
    const container = document.getElementById('doulasList');
    if (!doulas || doulas.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No doulas found.</div>';
        return;
    }
    
    container.innerHTML = doulas.map(d => `
        <div class="list-item" onclick="viewDoulaDetails(${d.id})">
            <div class="list-item-name">${escapeHtml(d.name)}</div>
            <div class="list-item-icon">Details &rsaquo;</div>
        </div>
    `).join('');
}

function viewDoulaDetails(id) {
    const d = doulas.find(item => item.id === id);
    if (!d) return;

    const modal = document.getElementById('detailsModal');
    const title = document.getElementById('detailsTitle');
    const body = document.getElementById('detailsBody');
    const actions = document.getElementById('detailsActions');

    title.textContent = d.name;
    body.innerHTML = `
        <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(d.phone)}">${formatPhone(d.phone)}</a></span></div>
        <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(d.email)}">${escapeHtml(d.email)}</a></span></div>
        <div class="detail-row"><span class="detail-label">Address:</span><span class="detail-value">${escapeHtml(d.address)}</span></div>
        <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value" style="white-space:pre-wrap;">${escapeHtml(d.servicesOffered)}</span></div>
    `;

    actions.innerHTML = `
        <button class="btn btn-edit" onclick="editDoula(${d.id})">Edit Profile</button>
        <button class="btn btn-danger" onclick="deleteItem('doula', ${d.id})">Delete</button>
    `;

    modal.classList.add('active');
}

// --- SERVICES (Table View - No changes to structure, just format) ---

function renderServices() {
  const tbody = document.getElementById('servicesTableBody');
  if (!services || services.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No services yet.</td></tr>';
    return;
  }
  tbody.innerHTML = services.map(s => `
    <tr>
      <td data-label="Service Name">${escapeHtml(s.serviceName)}</td>
      <td data-label="Client Price">$${Number(s.clientPrice).toFixed(2)}</td>
      <td data-label="Doula Payout">$${Number(s.doulaPayout).toFixed(2)}</td>
      <td data-label="Agency Profit">$${Number(s.agencyProfit).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editService(${s.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('service', ${s.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

// --- PAYCHECKS (Enhanced) ---

function updatePaycheckWeekFilter() {
    const select = document.getElementById('paycheckWeekFilter');
    const currentVal = select.value;
    
    // Get unique weeks
    const weeks = [...new Set(paychecks.map(p => p.weekNumber))].sort((a,b) => a-b);
    
    select.innerHTML = '<option value="all">Show All Weeks</option>' + 
        weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
    
    // Restore selection if possible
    if(weeks.includes(currentVal) || currentVal === 'all') {
        select.value = currentVal;
    }
}

function renderPaychecks() {
  const tbody = document.getElementById('paychecksTableBody');
  const filterWeek = document.getElementById('paycheckWeekFilter').value;
  
  let filtered = paychecks;
  if (filterWeek !== 'all') {
      filtered = paychecks.filter(p => String(p.weekNumber) === filterWeek);
  }

  if (!filtered || filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No paychecks found.</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.map(p => {
    // Improved Service Breakdown Styling
    const servicesList = (p.serviceDetails || []).map(sd => `
        <li class="paycheck-service-row">
            <span>${escapeHtml(sd.name)} <small style="color:#999;">x${sd.quantity}</small></span>
            <span class="paycheck-amount">$${(sd.amount).toFixed(2)}</span>
        </li>
    `).join('');

    return `
    <tr>
      <td data-label="Week">Week ${escapeHtml(p.weekNumber)}</td>
      <td data-label="Doula" style="font-weight:600; color:var(--primary);">${escapeHtml(p.doula)}</td>
      <td data-label="Date">${escapeHtml(p.invoiceDate)}</td>
      <td data-label="Services">
        <ul class="paycheck-service-list">
            ${servicesList || '<li style="color:#999;">No services</li>'}
        </ul>
      </td>
      <td data-label="Total" style="font-weight:bold;">$${Number(p.total).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editPaycheck(${p.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('paycheck', ${p.id})">Delete</button>
      </td>
    </tr>
  `}).join('');
}


// --- SUMMARY REPORTS (Redesigned) ---

function renderSummary() {
    const container = document.getElementById('summaryContent');
    const mode = document.getElementById('summaryType').value; // 'ytd' or 'weekly'
    const weekSelectWrapper = document.getElementById('summaryWeekSelectWrapper');
    const weekSelect = document.getElementById('summaryWeekSelect');

    // Handle Dropdown visibility
    if (mode === 'weekly') {
        weekSelectWrapper.style.display = 'block';
        // Populate weeks if empty
        const weeks = [...new Set(paychecks.map(p => p.weekNumber))].sort((a,b) => a-b);
        if (weekSelect.innerHTML === '') {
             weekSelect.innerHTML = weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
        }
    } else {
        weekSelectWrapper.style.display = 'none';
        weekSelect.innerHTML = ''; // Clear so it re-populates next time
    }

    // Logic
    if (mode === 'ytd') {
        renderYTDSummary(container);
    } else {
        const selectedWeek = weekSelect.value;
        if (!selectedWeek) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No weeks available data.</div>';
            return;
        }
        renderWeeklySummary(container, selectedWeek);
    }
}

function renderYTDSummary(container) {
    // 1. Total Agency Revenue (Gross) vs Payouts
    // 2. Breakdown per Doula (Total Paid)
    
    let totalPaid = 0;
    let doulaEarnings = {};

    paychecks.forEach(p => {
        const amt = Number(p.total || 0);
        totalPaid += amt;
        if (!doulaEarnings[p.doula]) doulaEarnings[p.doula] = 0;
        doulaEarnings[p.doula] += amt;
    });

    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">YTD Doula Payouts</div>
                <div class="stat-value">$${totalPaid.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Doulas</div>
                <div class="stat-value">${Object.keys(doulaEarnings).length}</div>
            </div>
        </div>
        
        <h3>Doula Earnings (YTD)</h3>
        <table>
            <thead><tr><th>Doula Name</th><th>Total Paid</th></tr></thead>
            <tbody>
    `;
    
    Object.keys(doulaEarnings).forEach(name => {
        html += `<tr><td>${name}</td><td>$${doulaEarnings[name].toFixed(2)}</td></tr>`;
    });
    
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function renderWeeklySummary(container, weekNum) {
    const weeklyChecks = paychecks.filter(p => String(p.weekNumber) === weekNum);
    
    let weeklyTotal = 0;
    let serviceCounts = {};

    weeklyChecks.forEach(p => {
        weeklyTotal += Number(p.total || 0);
        (p.serviceDetails || []).forEach(sd => {
            if (!serviceCounts[sd.name]) serviceCounts[sd.name] = { qty: 0, amt: 0 };
            serviceCounts[sd.name].qty += sd.quantity;
            serviceCounts[sd.name].amt += sd.amount;
        });
    });

    let html = `
        <div class="stats-grid">
             <div class="stat-card">
                <div class="stat-label">Week ${weekNum} Payouts</div>
                <div class="stat-value">$${weeklyTotal.toFixed(2)}</div>
            </div>
        </div>

        <h3>Service Breakdown (Week ${weekNum})</h3>
        <table>
            <thead><tr><th>Service</th><th>Quantity</th><th>Total Value</th></tr></thead>
            <tbody>
    `;

    Object.keys(serviceCounts).forEach(sName => {
        html += `<tr>
            <td>${sName}</td>
            <td>${serviceCounts[sName].qty}</td>
            <td>$${serviceCounts[sName].amt.toFixed(2)}</td>
        </tr>`;
    });

    if (Object.keys(serviceCounts).length === 0) {
        html += `<tr><td colspan="3" style="text-align:center;">No services recorded this week.</td></tr>`;
    }

    html += `</tbody></table>`;
    container.innerHTML = html;
}

// --- SAVE / EDIT / DELETE LOGIC ---

async function saveBooking(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const selectedServices = Array.from(document.querySelectorAll('#bookingServicesContainer input:checked'))
    .map(cb => {
      const service = services.find(s => s.id == cb.value);
      return service ? service.serviceName : '';
    }).filter(Boolean);
  
  const booking = {
    clientName: formData.get('clientName'),
    dueDate: formData.get('dueDate'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    services: selectedServices.join(', '),
    assignedDoula: formData.get('assignedDoula'),
    status: formData.get('status'),
    paid: formData.get('paid')
  };
  
  if (editingId) {
    booking.id = editingId;
    const idx = bookings.findIndex(b => b.id === editingId);
    if(idx !== -1) bookings[idx] = { ...bookings[idx], ...booking };
    await apiPut(`/api/bookings/${editingId}`, booking);
  } else {
    const created = await apiPost('/api/bookings', booking);
    bookings.push(created);
  }
  
  renderBookings();
  closeModal('bookingModal');
}

async function saveDoula(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const doula = {
    name: formData.get('name'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    address: formData.get('address'),
    servicesOffered: formData.get('servicesOffered')
  };
  
  if (editingId) {
    doula.id = editingId;
    const idx = doulas.findIndex(d => d.id === editingId);
    if(idx !== -1) doulas[idx] = { ...doulas[idx], ...doula };
    await apiPut(`/api/doulas/${editingId}`, doula);
  } else {
    const created = await apiPost('/api/doulas', doula);
    doulas.push(created);
  }
  
  renderDoulas();
  updateDoulaDropdowns();
  closeModal('doulaModal');
}

async function saveService(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const clientPrice = parseFloat(formData.get('clientPrice'));
  const doulaPayout = parseFloat(formData.get('doulaPayout'));
  const service = {
    serviceName: formData.get('serviceName'),
    clientPrice,
    doulaPayout,
    agencyProfit: clientPrice - doulaPayout
  };
  
  if (editingId) {
    service.id = editingId;
    const idx = services.findIndex(s => s.id === editingId);
    if(idx !== -1) services[idx] = { ...services[idx], ...service };
    await apiPut(`/api/services/${editingId}`, service);
  } else {
    const created = await apiPost('/api/services', service);
    services.push(created);
  }
  
  renderServices();
  closeModal('serviceModal');
}

async function savePaycheck(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const serviceLines = document.querySelectorAll('.service-line-item');
  
  const serviceDetails = [];
  let subtotal = 0;
  
  serviceLines.forEach(line => {
    const serviceSelect = line.querySelector('.paycheck-service');
    const quantityInput = line.querySelector('.paycheck-quantity');
    
    if (serviceSelect.value && quantityInput.value) {
      const serviceId = Number(serviceSelect.value);
      const service = services.find(s => s.id === serviceId);
      const quantity = parseInt(quantityInput.value);
      
      if (service) {
        const lineTotal = service.doulaPayout * quantity;
        serviceDetails.push({
          name: service.serviceName,
          quantity: quantity,
          rate: service.doulaPayout,
          amount: lineTotal
        });
        subtotal += lineTotal;
      }
    }
  });
  
  const hst = +(subtotal * 0.13).toFixed(2);
  const paycheck = {
    doula: formData.get('doula'),
    weekNumber: formData.get('weekNumber'),
    invoiceDate: formData.get('invoiceDate'),
    serviceDetails: serviceDetails,
    subtotal: +subtotal.toFixed(2),
    hst: hst,
    total: +(subtotal + hst).toFixed(2)
  };
  
  if (editingId) {
    paycheck.id = editingId;
    const idx = paychecks.findIndex(p => p.id === editingId);
    if(idx !== -1) paychecks[idx] = { ...paychecks[idx], ...paycheck };
    await apiPut(`/api/paychecks/${editingId}`, paycheck);
  } else {
    const created = await apiPost('/api/paychecks', paycheck);
    paychecks.push(created);
  }
  
  renderPaychecks();
  updatePaycheckWeekFilter();
  closeModal('paycheckModal');
}

// MODIFIED: Logic simplified, relies on openModal to set title
function editBooking(id) {
  closeModal('detailsModal'); // Close details if open
  const booking = bookings.find(b => b.id === id);
  if (!booking) return;
  editingId = id; // Crucial: set editingId before opening the modal
  
  const form = document.getElementById('bookingForm');
  form.elements.clientName.value = booking.clientName || '';
  form.elements.dueDate.value = booking.dueDate || ''; 
  form.elements.phone.value = booking.phone || '';
  form.elements.email.value = booking.email || '';
  form.elements.assignedDoula.value = booking.assignedDoula || '';
  form.elements.status.value = booking.status || '';
  form.elements.paid.value = booking.paid || '';
  
  // Call openModal *after* setting the form values (this runs renderBookingServicesCheckboxes)
  openModal('bookingModal');
  
  // Check checkboxes (must be done after renderBookingServicesCheckboxes inside openModal)
  const serviceNames = (booking.services || '').split(', ').map(s => s.trim());
  serviceNames.forEach(name => {
    const service = services.find(s => s.serviceName === name);
    if (service) {
      const checkbox = document.getElementById(`service_${service.id}`);
      if (checkbox) checkbox.checked = true;
    }
  });
}

// MODIFIED: Logic simplified, relies on openModal to set title
function editDoula(id) {
  closeModal('detailsModal');
  const doula = doulas.find(d => d.id === id);
  if (!doula) return;
  editingId = id;
  
  const form = document.getElementById('doulaForm');
  form.elements.name.value = doula.name || '';
  form.elements.phone.value = doula.phone || '';
  form.elements.email.value = doula.email || '';
  form.elements.address.value = doula.address || '';
  form.elements.servicesOffered.value = doula.servicesOffered || '';
  openModal('doulaModal');
}

// MODIFIED: Logic simplified, relies on openModal to set title
function editService(id) {
  const service = services.find(s => s.id === id);
  if (!service) return;
  editingId = id;
  
  const form = document.getElementById('serviceForm');
  form.elements.serviceName.value = service.serviceName || '';
  form.elements.clientPrice.value = service.clientPrice || '';
  form.elements.doulaPayout.value = service.doulaPayout || '';
  openModal('serviceModal');
}

// MODIFIED: Logic simplified, relies on openModal to set title
function editPaycheck(id) {
  const paycheck = paychecks.find(p => p.id === id);
  if (!paycheck) return;
  editingId = id;
  
  const form = document.getElementById('paycheckForm');
  form.elements.doula.value = paycheck.doula || '';
  form.elements.weekNumber.value = paycheck.weekNumber || '';
  form.elements.invoiceDate.value = paycheck.invoiceDate || '';
  
  const container = document.getElementById('paycheckServicesContainer');
  container.innerHTML = '';
  
  if (paycheck.serviceDetails && paycheck.serviceDetails.length > 0) {
    paycheck.serviceDetails.forEach(detail => {
      addPaycheckServiceLine();
      const lines = container.querySelectorAll('.service-line-item');
      const lastLine = lines[lines.length - 1];
      const service = services.find(s => s.serviceName === detail.name);
      if (service) {
        lastLine.querySelector('.paycheck-service').value = service.id;
        lastLine.querySelector('.paycheck-quantity').value = detail.quantity;
      }
    });
  } else {
    addPaycheckServiceLine();
  }
  openModal('paycheckModal');
}

async function deleteItem(type, id) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  await apiDelete(`/api/${type}s/${id}`);
  
  // Update local state
  if (type === 'booking') bookings = bookings.filter(b => b.id !== id);
  if (type === 'doula') doulas = doulas.filter(d => d.id !== id);
  if (type === 'service') services = services.filter(s => s.id !== id);
  if (type === 'paycheck') paychecks = paychecks.filter(p => p.id !== id);
  
  closeModal('detailsModal'); // Just in case it was triggered from details
  
  // Re-render
  renderBookings();
  renderDoulas();
  renderServices();
  renderPaychecks();
  updatePaycheckWeekFilter();
}


// --- HELPERS FOR FORMS ---
function renderBookingServicesCheckboxes() {
  const container = document.getElementById('bookingServicesContainer');
  
  container.innerHTML = services.map(s => `
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
      <input type="checkbox" id="service_${s.id}" value="${s.id}" style="width: 18px; height: 18px; margin: 0; flex-shrink: 0;">
      <label for="service_${s.id}" style="cursor: pointer; color: var(--text); margin: 0;">
        ${escapeHtml(s.serviceName)}
      </label>
    </div>
  `).join('');
}


function addPaycheckServiceLine() {
  const container = document.getElementById('paycheckServicesContainer');
  const serviceOptions = services.map(s => 
    `<option value="${s.id}">${escapeHtml(s.serviceName)} ($${Number(s.doulaPayout).toFixed(2)})</option>`
  ).join('');
  
  const line = document.createElement('div');
  line.className = 'service-line-item';
  line.style.display = 'flex';
  line.style.gap = '10px';
  line.style.marginBottom = '10px';
  line.innerHTML = `
    <div class="form-group" style="margin: 0; flex:2;">
      <select class="paycheck-service" required style="width:100%;">
        <option value="">Select Service</option>
        ${serviceOptions}
      </select>
    </div>
    <div class="form-group" style="margin: 0; flex:1;">
      <input type="number" class="paycheck-quantity" min="1" value="1" required style="width:100%;">
    </div>
    <button type="button" class="btn btn-small btn-remove-line" onclick="this.parentElement.remove()">X</button>
  `;
  container.appendChild(line);
}

function updateDoulaDropdowns() {
  const selects = [document.getElementById('assignedDoula'), document.getElementById('paycheckDoula')];
  selects.forEach(select => {
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Doula</option>' + 
      doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
    select.value = currentValue;
  });
}

// --- INIT APP FUNCTION ---
async function initApp() {
  try {
    const all = await apiGet('/api/all');
    bookings = all.bookings || [];
    doulas = all.doulas || [];
    services = all.services || [];
    paychecks = all.paychecks || [];

    renderBookings();
    renderDoulas();
    renderServices();
    renderPaychecks();
    updatePaycheckWeekFilter();
    updateDoulaDropdowns();
  } catch (err) {
    console.error('Load failed', err);
    alert('Could not load data. Check server.');
  }
}

// --- INITIAL PAGE LOAD CHECK ---
window.addEventListener('load', () => {
    if (localStorage.getItem(AUTH_KEY) === 'true') {
        // If auth key exists, show the main app immediately
        showMainApp();
    } else {
        // Otherwise, the login modal is active by default in HTML
        // Ensure the main container is hidden
        document.getElementById('mainAppContainer').style.display = 'none';
        document.getElementById('loginModal').classList.add('active');
    }
});
</script>
</body>
</html>