<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greater Toronto Doulas - Management System</title>
    <style>
        :root {
            --primary: #8b7355;
            --secondary: #d4a574;
            --bg: #f8f5f2;
            --white: #ffffff;
            --text: #444;
            --gray-light: #e8e0d8;
            --danger: #c17b5f;
            --success: #6b8e23;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--secondary);
        }
        h1 { color: var(--primary); font-weight: 300; letter-spacing: 1px; margin-bottom: 5px;}
        .tagline { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; }

        /* --- Navigation --- */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--primary);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-btn.active, .tab-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(139, 115, 85, 0.2);
        }

        /* --- Tab Content --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary); font-weight: 300; margin-bottom: 20px; }

        /* --- Controls --- */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input, .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .search-input { width: 100%; max-width: 300px; }

        /* --- List Views (Bookings & Doulas) --- */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .list-item {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-color: var(--secondary);
        }
        .list-item-name {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--primary);
        }
        .list-item-icon { color: var(--secondary); font-size: 1.2em; }

        /* --- Tables (Services & Paychecks) --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 10px;
        }
        th {
            text-align: left;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        tr {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        td { padding: 15px; border-top: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); vertical-align: middle; }
        td:first-child { border-left: 1px solid var(--gray-light); border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: 500; color: var(--primary); }
        td:last-child { border-right: 1px solid var(--gray-light); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* Paycheck Service styling */
        .paycheck-service-list { list-style: none; font-size: 0.9em; }
        .paycheck-service-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dashed #eee; }
        .paycheck-service-row:last-child { border-bottom: none; }
        .paycheck-amount { font-weight: 600; color: #666; margin-left: 10px; }

        /* --- Buttons --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: background 0.2s;
        }
        .btn:hover { background: #6d5942; }
        
        .btn-secondary { background: var(--gray-light); color: var(--primary); }
        .btn-small { padding: 6px 12px; font-size: 0.8em; margin-right: 5px; border-radius: 4px; }        
        .btn-edit { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-add-line { background: var(--secondary); margin-top: 10px; width: 100%; }
        .btn-remove-line { background: var(--danger); padding: 5px 10px; margin-left: 10px; }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px); align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fefefe; padding: 30px; border-radius: 12px;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--gray-light); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 2rem; cursor: pointer; border: none; background: none; color: #999; line-height: 1; }
        
        /* Details View in Modal */
        .detail-row { display: flex; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
        .detail-label { width: 120px; font-weight: 600; color: #888; flex-shrink: 0; }
        .detail-value { color: #333; flex-grow: 1; }
        .detail-actions { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--gray-light); text-align: right; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        input, select, textarea { padding: 12px; border: 1px solid var(--gray-light); border-radius: 6px; font-size: 1em; background: #fafafa; width: 100%; }
        
#bookingServicesContainer label {
    display: flex;
    align-items: center; /* vertically center */
    gap: 8px;
    margin-bottom: 0;
}

/* Nudge the text slightly up */
#bookingServicesContainer label span {
    display: inline-block;
    transform: translateY(-1px); /* adjust as needed, -1px or -2px */
}

/* Make sure checkbox itself is consistent size */
#bookingServicesContainer input[type="checkbox"],
#bookingServicesContainer input[type="radio"] {
    width: 18px;
    height: 18px;
    margin: 0;
    flex-shrink: 0;
}



        /* Login Form Styles - Ensure this modal is always active on load until login */
        .login-form-container {
            padding: 30px;
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-form-container h2 {
            color: var(--primary);
            margin-bottom: 25px;
        }
        .login-form-container .form-group {
            margin-bottom: 20px;
        }
        .login-form-container input[type="text"], 
        .login-form-container input[type="password"] {
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            width: 100%;
        }
        .login-form-container .btn {
            width: 100%;
            margin-top: 15px;
        }

.action-btns {
  display: flex;
  gap: 10px;
  justify-content: flex-start;
  flex-wrap: nowrap;
  align-items: center;
  width: fit-content;
  max-width: 200px;
}

/* Ensure the actions column doesn't stretch */
#paychecksTable td.action-btns {
  width: auto;
  min-width: 180px;
  padding: 15px;
}

/* Ensure all table cells have consistent padding and borders */
#paychecksTable td {
  padding: 15px;
  border-bottom: 1px solid #e0e0e0;
  vertical-align: middle;
}

#paychecksTable tr {
  border-bottom: 1px solid #e0e0e0;
}

/* Remove double borders */
#paychecksTable tr:last-child td {
  border-bottom: none;
}

.action-btns .btn {
  margin: 0;
  white-space: nowrap;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 30px;
  flex-wrap: wrap;
}
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .controls-bar { flex-direction: column-reverse; align-items: stretch; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid var(--gray-light); border-radius: 8px; padding: 10px; }
            td { border: none; padding: 8px 5px; display: flex; justify-content: space-between; text-align: right; }
            td::before { content: attr(data-label) ":"; font-weight: bold; text-transform: uppercase; margin-right: 10px; color: #777; flex-shrink: 0; }
            td:first-child, td:last-child { border-radius: 0; }
            .action-btns { justify-content: flex-end; width: 100%; }
        }
        @media (max-width: 500px) {
             .form-grid { grid-template-columns: 1fr; }
        }

        /* Summary Report Styles */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 25px;
            text-align: center;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 300;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <div id="loginModal" class="modal active">
        <div class="login-form-container">
            <h2>GTD Management Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
                <p id="loginMessage" style="color: var(--danger); margin-top: 10px;"></p>
            </form>
        </div>
    </div>
    
    <div id="mainAppContainer" style="display: none;">
        <div class="container">

            <header style="position: relative;">
                <h1>Greater Toronto Doulas</h1>
                <p class="tagline">Management System</p>
                <button class="btn btn-secondary btn-small" style="position: absolute; top: 10px; right: 20px;" onclick="handleLogout()">Logout</button>
            </header>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('bookings', event)">Bookings</button>
                <button class="tab-btn" onclick="switchTab('doulas', event)">Doulas</button>
                <button class="tab-btn" onclick="switchTab('services', event)">Services</button>
                <button class="tab-btn" onclick="switchTab('paychecks', event)">Paychecks</button>
                <button class="tab-btn" onclick="switchTab('summary', event)">Reports</button>
            </div>

            <div id="bookingsTab" class="tab-content active">
                <div class="controls-bar">
                    <button class="btn" onclick="newBooking()">+ Log New Booking</button>
                    <input type="text" id="bookingSearch" class="search-input" placeholder="Search Bookings by Client/Doula..." onkeyup="renderBookings()">
                </div>
                <div id="bookingsList" class="list-container">
                    </div>
            </div>

            <div id="doulasTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newDoula()">+ Add New Doula</button>
                    <input type="text" id="doulaSearch" class="search-input" placeholder="Search Doulas by Name/Service..." onkeyup="renderDoulas()">
                </div>
                <div id="doulasList" class="list-container">
                    </div>
            </div>
            
            <div id="servicesTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newService()">+ Add New Service</button>
                    <input type="text" id="serviceSearch" class="search-input" placeholder="Search Services..." onkeyup="renderServices()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Client Price</th>
                            <th>Doula Payout</th>
                            <th>Agency Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        </tbody>
                </table>
            </div>

            <div id="paychecksTab" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="newPaycheck()">+ Generate Paycheck</button>
                    <select id="paycheckWeekFilter" class="filter-select" onchange="renderPaychecks()">
                        <option value="">All Weeks</option>
                    </select>
                    <select id="paycheckDoulaFilter" class="filter-select" onchange="renderPaychecks()">
                        <option value="">All Doulas</option>
                    </select>
                </div>
                <table id="paychecksTable">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Doula</th>
                            <th>Date</th>
                            <th>Services</th>
                            <th>Total Payout</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paychecksTableBody">
                        </tbody>
                </table>
            </div>

            <div id="summaryTab" class="tab-content">
                <h2>Summary Report</h2>
                <div id="summaryStats" class="stat-grid">
                    </div>
                <h2>Services Performed This Week</h2>
                <div class="controls-bar">
                    <input type="week" id="reportWeek" class="filter-select" onchange="renderSummary()">
                </div>
                <div id="servicesReportContainer">
                    </div>
            </div>

        </div> </div> <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookingModalTitle">New Booking</h2>
                <button class="close-btn" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Assigned Doula</label>
                        <select name="assignedDoula" id="assignedDoula">
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Current">Current</option>
                            <option value="Completed">Completed</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paid</label>
                        <select name="paid">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services *</label>
                        <div class="multi-select-checkbox-group" id="bookingServicesContainer">
                            </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bookingModal')">Cancel</button>
                    <button type="submit" class="btn">Save Booking</button>
                </div>
            </form>
        </div>
    </div>

    <div id="doulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="doulaModalTitle">Add Doula</h2>
                <button class="close-btn" onclick="closeModal('doulaModal')">&times;</button>
            </div>
            <form id="doulaForm" onsubmit="saveDoula(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services Offered (Comma Separated)</label>
                        <textarea name="servicesOffered"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('doulaModal')">Cancel</button>
                    <button type="submit" class="btn">Save Doula</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Add Service</h2>
                <button class="close-btn" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Name *</label>
                        <input type="text" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Price * ($)</label>
                        <input type="number" name="clientPrice" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Doula Payout * ($)</label>
                        <input type="number" name="doulaPayout" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Agency Profit * ($)</label>
                        <input type="number" name="agencyProfit" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('serviceModal')">Cancel</button>
                    <button type="submit" class="btn">Save Service</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="paycheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paycheckModalTitle">Generate Paycheck</h2>
                <button class="close-btn" onclick="closeModal('paycheckModal')">&times;</button>
            </div>
            <form id="paycheckForm" onsubmit="savePaycheck(event)">
                <input type="hidden" name="id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Doula *</label>
                        <select name="doula" id="paycheckDoula" required>
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="number" name="weekNumber" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" name="invoiceDate" required>
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px dashed var(--gray-light);">
                <h3>Services Breakdown</h3>
                
                <div id="paycheckServicesContainer">
                    </div>
                
                <button type="button" class="btn btn-add-line" onclick="addPaycheckServiceLine()">+ Add Service Line</button>

                <div style="margin-top: 20px; text-align: right; font-size: 1.1em;">
                    <p>Subtotal: <strong id="paycheckSubtotal">$0.00</strong></p>
                    <p>HST (13%): <strong id="paycheckHst">$0.00</strong></p>
                    <p style="font-size: 1.4em; font-weight: bold; color: var(--primary);">Total Payout: <strong id="paycheckTotal">$0.00</strong></p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paycheckModal')">Cancel</button>
                    <button type="submit" class="btn">Save Paycheck</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsModalTitle">Details</h2>
                <button class="close-btn" onclick="closeModal('detailsModal')">&times;</button>
            </div>
            <div id="detailsModalBody">
                </div>
            <div id="detailsModalActions" class="detail-actions">
                </div>
        </div>
    </div>


    <script>
        const API_BASE = 'https://gtd-1rkv.onrender.com'; // Change to '' if hosted on same server
        const AUTH_KEY = 'gtd_admin_logged_in';
        const STATIC_USERNAME = 'GTDAdmin';
        const STATIC_PASSWORD = 'Doula@123'; // NOTE: This is client-side and not secure.

        let bookings = [];
        let doulas = [];
        let services = [];
        let paychecks = [];
        let editingId = null;

        // --- UTILS ---

        function formatPhone(str) {
            if(!str) return '';
            const cleaned = ('' + str).replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return '(' + match[1] + ') ' + match[2] + '-' + match[3];
            }
            return str;
        }

        function escapeHtml(unsafe) {
            if (unsafe === undefined || unsafe === null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // --- API HELPERS ---
        async function apiCall(method, path, data) {
            const response = await fetch(API_BASE + path, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: data ? JSON.stringify(data) : undefined,
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            return response.json();
        }

        const apiGet = (path) => apiCall('GET', path);
        const apiPost = (path, data) => apiCall('POST', path, data);
        const apiPut = (path, data) => apiCall('PUT', path, data);
        const apiDelete = (path) => apiCall('DELETE', path);
        
        // --- AUTH LOGIC ---

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        async function handleLogin(e) {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const messageEl = document.getElementById('loginMessage');
            
            if (username === STATIC_USERNAME && password === STATIC_PASSWORD) {
                localStorage.setItem(AUTH_KEY, 'true');
                showMainApp();
            } else {
                messageEl.textContent = 'Invalid username or password.';
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem(AUTH_KEY);
                window.location.reload();
            }
        }

        // --- TAB SWITCHING ---

        // Function to switch tabs
        function switchTab(tabId, event) {
            // Deactivate all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activate selected tab and content
            document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // FIX 1: Scroll to the top of the page when switching tabs.
            // This prevents the page from anchoring below the navigation bar.
            window.scrollTo(0, 0); 
        }

        // --- BOOKINGS (List View + Details Modal) ---

        function renderBookings() {
            const container = document.getElementById('bookingsList');
            const searchTerm = document.getElementById('bookingSearch').value.toLowerCase();
            
            const filteredBookings = bookings.filter(b => 
                (b.clientName && b.clientName.toLowerCase().includes(searchTerm)) ||
                (b.assignedDoula && b.assignedDoula.toLowerCase().includes(searchTerm))
            );

            container.innerHTML = filteredBookings.map(b => `
                <div class="list-item" onclick="showBookingDetails(${b.id})">
                    <div class="list-item-name">${escapeHtml(b.clientName)} - ${escapeHtml(b.assignedDoula || 'Unassigned')}</div>
                    <div class="list-item-icon">${escapeHtml(b.status)}</div>
                </div>
            `).join('');
        }

        function newBooking() {
            editingId = null;
            openModal('bookingModal');
        }

        function showBookingDetails(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsModalTitle').textContent = `Booking Details: ${escapeHtml(booking.clientName)}`;
            const body = document.getElementById('detailsModalBody');
            const actions = document.getElementById('detailsModalActions');

            const b = booking;
            body.innerHTML = `
                <div class="detail-row"><span class="detail-label">Client Name:</span><span class="detail-value">${escapeHtml(b.clientName)}</span></div>
                <div class="detail-row"><span class="detail-label">Due Date:</span><span class="detail-value">${escapeHtml(b.dueDate || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(b.phone)}">${formatPhone(b.phone)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(b.email)}">${escapeHtml(b.email)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Doula:</span><span class="detail-value">${escapeHtml(b.assignedDoula || 'Unassigned')}</span></div>
                <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value">${escapeHtml(b.status)}</span></div>
                <div class="detail-row"><span class="detail-label">Paid:</span><span class="detail-value">${escapeHtml(b.paid)}</span></div>
                <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value">${escapeHtml(b.services)}</span></div>
            `;
            actions.innerHTML = `
                <button class="btn btn-edit" onclick="editBooking(${b.id})">Edit Booking</button>
                <button class="btn btn-danger" onclick="deleteItem('booking', ${b.id})">Delete</button>
            `;
            modal.classList.add('active');
        }

        // --- DOULAS (Card View + Details Modal) ---

        function renderDoulas() {
            const container = document.getElementById('doulasList');
            const searchTerm = document.getElementById('doulaSearch').value.toLowerCase();
            
            if (!doulas || doulas.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">No doulas found.</p>';
                return;
            }

            const filteredDoulas = doulas.filter(d => 
                (d.name && d.name.toLowerCase().includes(searchTerm)) ||
                (d.servicesOffered && d.servicesOffered.toLowerCase().includes(searchTerm))
            );
            
            container.innerHTML = filteredDoulas.map(d => `
                <div class="list-item" onclick="showDoulaDetails(${d.id})">
                    <div class="list-item-name">${escapeHtml(d.name)}</div>
                    <div class="list-item-icon">${escapeHtml(d.servicesOffered)}</div>
                </div>
            `).join('');
        }

        function newDoula() {
            editingId = null;
            openModal('doulaModal');
        }

        function showDoulaDetails(id) {
            const doula = doulas.find(d => d.id === id);
            if (!doula) return;

            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsModalTitle').textContent = `Doula Details: ${escapeHtml(doula.name)}`;
            const body = document.getElementById('detailsModalBody');
            const actions = document.getElementById('detailsModalActions');

            const d = doula;
            body.innerHTML = `
                <div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value">${escapeHtml(d.name)}</span></div>
                <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value"><a href="tel:${escapeHtml(d.phone)}">${formatPhone(d.phone)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value"><a href="mailto:${escapeHtml(d.email)}">${escapeHtml(d.email)}</a></span></div>
                <div class="detail-row"><span class="detail-label">Address:</span><span class="detail-value">${escapeHtml(d.address || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Services:</span><span class="detail-value">${escapeHtml(d.servicesOffered || 'None listed')}</span></div>
            `;
            actions.innerHTML = `
                <button class="btn btn-edit" onclick="editDoula(${d.id})">Edit Doula</button>
                <button class="btn btn-danger" onclick="deleteItem('doula', ${d.id})">Delete</button>
            `;
            modal.classList.add('active');
        }

        // --- SERVICES (Table View + Edit Modal) ---
        
        function renderServices() {
            const container = document.getElementById('servicesTableBody');
            const searchTerm = document.getElementById('serviceSearch').value.toLowerCase();
            
            const filteredServices = services.filter(s => 
                (s.serviceName && s.serviceName.toLowerCase().includes(searchTerm))
            );

            container.innerHTML = filteredServices.map(s => `
                <tr>
                    <td data-label="Service Name">${escapeHtml(s.serviceName)}</td>
                    <td data-label="Client Price">$${Number(s.clientPrice).toFixed(2)}</td>
                    <td data-label="Doula Payout">$${Number(s.doulaPayout).toFixed(2)}</td>
                    <td data-label="Agency Profit">$${Number(s.agencyProfit).toFixed(2)}</td>
                    <td data-label="Actions">
                        <button class="btn btn-small btn-edit" onclick="editService(${s.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteItem('service', ${s.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function newService() {
            editingId = null;
            openModal('serviceModal');
        }

        function editService(id) {
            const service = services.find(s => s.id === id);
            if (!service) return;

            editingId = id;
            const form = document.getElementById('serviceForm');
            form.elements.serviceName.value = service.serviceName || '';
            form.elements.clientPrice.value = service.clientPrice || 0;
            form.elements.doulaPayout.value = service.doulaPayout || 0;
            form.elements.agencyProfit.value = service.agencyProfit || 0;
            
            openModal('serviceModal');
        }
        
        // --- PAYCHECKS (Table View + Generate Modal) ---

        function renderPaychecks() {
            const container = document.getElementById('paychecksTableBody');
            const weekFilter = document.getElementById('paycheckWeekFilter').value;
            const doulaFilter = document.getElementById('paycheckDoulaFilter').value;

            const filteredPaychecks = paychecks.filter(p => {
                const weekMatch = !weekFilter || p.weekNumber === weekFilter;
                const doulaMatch = !doulaFilter || p.doula === doulaFilter;
                return weekMatch && doulaMatch;
            });
            
            container.innerHTML = filteredPaychecks.map(p => {
                // Improved Service Breakdown Styling
                const servicesList = (p.serviceDetails || []).map(sd => `
                    <li class="paycheck-service-row">
                        <span>${escapeHtml(sd.name)} <small style="color:#999;">x${sd.quantity}</small></span>
                        <span class="paycheck-amount">$${(sd.amount).toFixed(2)}</span>
                    </li>
                `).join('');

                return `
                    <tr>
                        <td data-label="Week">Week ${escapeHtml(p.weekNumber)}</td>
                        <td data-label="Doula" style="font-weight:600; color:var(--primary);">${escapeHtml(p.doula)}</td>
                        <td data-label="Date">${escapeHtml(p.invoiceDate)}</td>
                        <td data-label="Services">
                            <ul class="paycheck-service-list">
                                ${servicesList || '<li style="color:#999;">No services</li>'}
                            </ul>
                        </td>
                        <td data-label="Total" style="font-weight:bold;">$${Number(p.total).toFixed(2)}</td>
                        <td class="action-btns">
                            <button class="btn btn-small btn-edit" onclick="editPaycheck(${p.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteItem('paycheck', ${p.id})">Delete</button>
                        </td>
                    </tr>
                `}).join('');
        }

        function updatePaycheckWeekFilter() {
            const select = document.getElementById('paycheckWeekFilter');
            const weeks = [...new Set(paychecks.map(p => p.weekNumber))].sort((a, b) => Number(b) - Number(a)); // Sort descending
            const current = select.value;
            select.innerHTML = '<option value="">All Weeks</option>' + 
                weeks.map(w => `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('');
            select.value = current;
        }

        function newPaycheck() {
            editingId = null;
            openModal('paycheckModal');
        }
        
        function editPaycheck(id) {
            const paycheck = paychecks.find(p => p.id === id);
            if (!paycheck) return;

            editingId = id;
            const form = document.getElementById('paycheckForm');
            
            form.elements.doula.value = paycheck.doula || '';
            form.elements.weekNumber.value = paycheck.weekNumber || '';
            form.elements.invoiceDate.value = paycheck.invoiceDate || '';

            const container = document.getElementById('paycheckServicesContainer');
            container.innerHTML = ''; // Clear existing lines

            if (paycheck.serviceDetails && paycheck.serviceDetails.length > 0) {
                paycheck.serviceDetails.forEach(detail => {
                    addPaycheckServiceLine();
                    const lines = container.querySelectorAll('.service-line-item');
                    const lastLine = lines[lines.length - 1];
                    const service = services.find(s => s.serviceName === detail.name);
                    
                    if (service) {
                        lastLine.querySelector('.paycheck-service').value = service.id;
                        lastLine.querySelector('.paycheck-quantity').value = detail.quantity;
                    }
                });
            } else {
                addPaycheckServiceLine();
            }

            // Must manually trigger total update after populating lines
            calculatePaycheckTotals(); 

            openModal('paycheckModal');
        }

        function calculatePaycheckTotals() {
            let subtotal = 0;
            const lines = document.getElementById('paycheckServicesContainer').querySelectorAll('.service-line-item');

            lines.forEach(line => {
                const serviceId = line.querySelector('.paycheck-service').value;
                const quantity = Number(line.querySelector('.paycheck-quantity').value);
                const service = services.find(s => s.id == serviceId);
                
                if (service && quantity > 0) {
                    subtotal += service.doulaPayout * quantity;
                }
            });

            const hst = subtotal * 0.13;
            const total = subtotal + hst;
            
            document.getElementById('paycheckSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('paycheckHst').textContent = `$${hst.toFixed(2)}`;
            document.getElementById('paycheckTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        // Listen for changes in the Paycheck modal to update totals
        document.getElementById('paycheckModal').addEventListener('input', (e) => {
             // Only recalculate on changes to service or quantity inputs inside a line item
             if (e.target.classList.contains('paycheck-service') || e.target.classList.contains('paycheck-quantity')) {
                calculatePaycheckTotals();
             }
        });

        function addPaycheckServiceLine() {
            const container = document.getElementById('paycheckServicesContainer');
            
            // Generate service options dynamically based on available services
            const serviceOptions = services.map(s => 
                `<option value="${s.id}">${escapeHtml(s.serviceName)} - $${Number(s.doulaPayout).toFixed(2)} p/u</option>`
            ).join('');

            const line = document.createElement('div');
            line.className = 'service-line-item form-grid';
            line.style.marginBottom = '10px';
            line.style.alignItems = 'flex-end';
            line.style.gap = '10px';
            line.style.gridTemplateColumns = '3fr 1fr auto';

            line.innerHTML = `
                <div class="form-group" style="margin: 0; flex:3;">
                    <label>Service</label>
                    <select class="paycheck-service" required style="width:100%;">
                        <option value="">Select Service</option>
                        ${serviceOptions}
                    </select>
                </div>
                <div class="form-group" style="margin: 0; flex:1;">
                    <label>Qty</label>
                    <input type="number" class="paycheck-quantity" min="1" value="1" required style="width:100%;">
                </div>
                <button type="button" class="btn btn-small btn-remove-line" onclick="this.closest('.service-line-item').remove(); calculatePaycheckTotals();">X</button>
            `;
            container.appendChild(line);

            // Recalculate totals every time a new line is added
            calculatePaycheckTotals();
        }

        // --- SUMMARY REPORTS ---

        function renderSummary() {
            const statsContainer = document.getElementById('summaryStats');
            const bookingsCompleted = bookings.filter(b => b.status === 'Completed').length;
            const totalDoulas = doulas.length;
            const totalProfit = paychecks.reduce((sum, p) => {
                // Find services used in paycheck
                const paycheckServiceDetails = p.serviceDetails || [];
                
                const paycheckProfit = paycheckServiceDetails.reduce((pSum, sd) => {
                    const service = services.find(s => s.serviceName === sd.name);
                    if (service) {
                         // Calculate profit per service based on quantity
                         const profitPerUnit = service.clientPrice - service.doulaPayout;
                         return pSum + (profitPerUnit * sd.quantity);
                    }
                    return pSum;
                }, 0);
                
                // Note: This logic for profit is flawed if the service details in paychecks.json 
                // only contain the payout amount, not the client price. 
                // Assuming services object is the source of truth for profit.
                return sum + paycheckProfit;
            }, 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Doulas</div>
                    <div class="stat-value">${totalDoulas}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed Bookings</div>
                    <div class="stat-value">${bookingsCompleted}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Estimated Profit (YTD)</div>
                    <div class="stat-value">$${totalProfit.toFixed(2)}</div>
                </div>
            `;
            
            // Service Report by Week
            const reportWeekInput = document.getElementById('reportWeek');
            const currentWeek = reportWeekInput.value || getDefaultWeek();
            
            if (!reportWeekInput.value) {
                reportWeekInput.value = currentWeek; // Set default value visually
            }

            const weekNumber = currentWeek.substring(currentWeek.indexOf('W') + 1);
            
            const weeklyPaychecks = paychecks.filter(p => p.weekNumber === weekNumber);
            const serviceCounts = {};

            weeklyPaychecks.forEach(p => {
                (p.serviceDetails || []).forEach(sd => {
                    const sName = sd.name;
                    const amount = sd.amount; // This is the doula payout amount for this service line
                    const quantity = sd.quantity;
                    
                    if (!serviceCounts[sName]) {
                        serviceCounts[sName] = { qty: 0, amt: 0 };
                    }
                    serviceCounts[sName].qty += quantity;
                    // For the report, let's track the Client Price total (not doula payout)
                    const serviceConfig = services.find(s => s.serviceName === sName);
                    if (serviceConfig) {
                        serviceCounts[sName].amt += serviceConfig.clientPrice * quantity;
                    }
                });
            });

            const container = document.getElementById('servicesReportContainer');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Total Quantity</th>
                            <th>Total Client Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(serviceCounts).forEach(sName => {
                html += `<tr> 
                    <td>${sName}</td> 
                    <td>${serviceCounts[sName].qty}</td> 
                    <td>$${serviceCounts[sName].amt.toFixed(2)}</td> 
                </tr>`;
            });

            if (Object.keys(serviceCounts).length === 0) {
                html += `<tr><td colspan="3" style="text-align:center;">No services recorded this week.</td></tr>`;
            }
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function getDefaultWeek() {
            const now = new Date();
            const year = now.getFullYear();
            
            // Calculate week number (ISO 8601 compliant)
            const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            
            const weekStr = String(weekNo).padStart(2, '0');
            return `${year}-W${weekStr}`;
        }
        
        // --- SAVE / EDIT / DELETE LOGIC ---

        async function saveBooking(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const selectedServices = Array.from(document.querySelectorAll('#bookingServicesContainer input:checked'))
                .map(cb => {
                    const service = services.find(s => s.id == cb.value);
                    return service ? service.serviceName : '';
                }).filter(Boolean);
            
            const booking = {
                clientName: formData.get('clientName'),
                dueDate: formData.get('dueDate'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                services: selectedServices.join(', '),
                assignedDoula: formData.get('assignedDoula'),
                status: formData.get('status'),
                paid: formData.get('paid')
            };

            // FIX 2: Added try...catch block to handle API errors and provide user feedback
            try {
                if (editingId) {
                    booking.id = editingId;
                    const idx = bookings.findIndex(b => b.id === editingId);
                    if(idx !== -1) bookings[idx] = { ...bookings[idx], ...booking };
                    await apiPut(`/api/bookings/${editingId}`, booking);
                } else {
                    // Note: The API should return the new object with an ID
                    const created = await apiPost('/api/bookings', booking);
                    bookings.push(created);
                }
                renderBookings();
                closeModal('bookingModal');
            } catch (error) {
                console.error("Error saving booking:", error);
                alert('Failed to save booking. Check the server connection and ensure all required fields are filled.');
            }
        }

        async function saveDoula(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const doula = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                servicesOffered: formData.get('servicesOffered')
            };
            
            try {
                if (editingId) {
                    doula.id = editingId;
                    const idx = doulas.findIndex(d => d.id === editingId);
                    if(idx !== -1) doulas[idx] = { ...doulas[idx], ...doula };
                    await apiPut(`/api/doulas/${editingId}`, doula);
                } else {
                    const created = await apiPost('/api/doulas', doula);
                    doulas.push(created);
                }
                renderDoulas();
                updateDoulaDropdowns(); // Update doula dropdowns across the app
                closeModal('doulaModal');
            } catch (error) {
                console.error("Error saving doula:", error);
                alert('Failed to save doula. Check the server connection and ensure all required fields are filled.');
            }
        }

        async function saveService(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const service = {
                serviceName: formData.get('serviceName'),
                clientPrice: Number(formData.get('clientPrice')),
                doulaPayout: Number(formData.get('doulaPayout')),
                agencyProfit: Number(formData.get('agencyProfit'))
            };
            
            try {
                if (editingId) {
                    service.id = editingId;
                    const idx = services.findIndex(s => s.id === editingId);
                    if(idx !== -1) services[idx] = { ...services[idx], ...service };
                    await apiPut(`/api/services/${editingId}`, service);
                } else {
                    const created = await apiPost('/api/services', service);
                    services.push(created);
                }
                renderServices();
                // We should also update booking service checkboxes and paycheck service dropdowns
                renderBookingServicesCheckboxes(); 
                updatePaycheckServiceDropdowns();
                closeModal('serviceModal');
            } catch (error) {
                console.error("Error saving service:", error);
                alert('Failed to save service. Check the server connection and ensure all required fields are filled.');
            }
        }
        
        async function savePaycheck(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Re-calculate totals based on current form state before saving
            let subtotal = 0;
            const serviceDetails = [];
            const lines = document.getElementById('paycheckServicesContainer').querySelectorAll('.service-line-item');

            lines.forEach(line => {
                const serviceId = line.querySelector('.paycheck-service').value;
                const quantity = Number(line.querySelector('.paycheck-quantity').value);
                const service = services.find(s => s.id == serviceId);
                
                if (service && quantity > 0) {
                    const amount = service.doulaPayout * quantity;
                    serviceDetails.push({ name: service.serviceName, quantity: quantity, amount: amount });
                    subtotal += amount;
                }
            });

            // Basic validation
            if (serviceDetails.length === 0) {
                 alert("Please add at least one service line item.");
                 return;
            }

            const hst = +(subtotal * 0.13).toFixed(2);

            const paycheck = {
                doula: formData.get('doula'),
                weekNumber: formData.get('weekNumber'),
                invoiceDate: formData.get('invoiceDate'),
                serviceDetails: serviceDetails, // Array of service objects with name, quantity, amount
                subtotal: +subtotal.toFixed(2),
                hst: hst,
                total: +(subtotal + hst).toFixed(2)
            };
            
            // FIX 2: Added try...catch block to handle API errors and provide user feedback
            try {
                if (editingId) {
                    paycheck.id = editingId;
                    const idx = paychecks.findIndex(p => p.id === editingId);
                    if(idx !== -1) paychecks[idx] = { ...paychecks[idx], ...paycheck };
                    await apiPut(`/api/paychecks/${editingId}`, paycheck);
                } else {
                    const created = await apiPost('/api/paychecks', paycheck);
                    paychecks.push(created);
                }
                renderPaychecks();
                updatePaycheckWeekFilter();
                closeModal('paycheckModal');
                renderSummary(); // Update reports after adding a paycheck
            } catch (error) {
                console.error("Error saving paycheck:", error);
                alert('Failed to save paycheck. Check the server connection and ensure all required fields are filled.');
            }
        }

        // MODIFIED: Logic simplified, relies on openModal to set title
        function editBooking(id) {
            closeModal('detailsModal'); // Close details if open
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            editingId = id; // Crucial: set editingId before opening the modal
            const form = document.getElementById('bookingForm');
            
            form.elements.clientName.value = booking.clientName || '';
            form.elements.dueDate.value = booking.dueDate || '';
            form.elements.phone.value = booking.phone || '';
            form.elements.email.value = booking.email || '';
            form.elements.assignedDoula.value = booking.assignedDoula || '';
            form.elements.status.value = booking.status || 'Current';
            form.elements.paid.value = booking.paid || 'No';

            // Handle services checkboxes
            const selectedServices = (booking.services || '').split(', ').filter(Boolean);
            document.querySelectorAll('#bookingServicesContainer input[type="checkbox"]').forEach(cb => {
                // Remove the checked state first
                cb.checked = false; 
                // Then set checked state if service is in the list
                if (selectedServices.includes(cb.name)) {
                    cb.checked = true;
                }
            });

            openModal('bookingModal');
        }

        function editDoula(id) {
            closeModal('detailsModal');
            const doula = doulas.find(d => d.id === id);
            if (!doula) return;

            editingId = id;
            const form = document.getElementById('doulaForm');
            form.elements.name.value = doula.name || '';
            form.elements.phone.value = doula.phone || '';
            form.elements.email.value = doula.email || '';
            form.elements.address.value = doula.address || '';
            form.elements.servicesOffered.value = doula.servicesOffered || '';

            openModal('doulaModal');
        }

        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                await apiDelete(`/api/${type}s/${id}`);
                
                // Remove from local array
                if (type === 'booking') {
                    bookings = bookings.filter(b => b.id !== id);
                    renderBookings();
                } else if (type === 'doula') {
                    doulas = doulas.filter(d => d.id !== id);
                    renderDoulas();
                    updateDoulaDropdowns(); // Update dropdowns after delete
                } else if (type === 'service') {
                    services = services.filter(s => s.id !== id);
                    renderServices();
                    renderBookingServicesCheckboxes(); // Re-render service options
                    updatePaycheckServiceDropdowns();
                } else if (type === 'paycheck') {
                    paychecks = paychecks.filter(p => p.id !== id);
                    renderPaychecks();
                    updatePaycheckWeekFilter();
                    renderSummary(); // Update reports after delete
                }
                
                closeModal('detailsModal'); // Close any details modal that might be open
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully.`);
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                alert(`Failed to delete ${type}. Check the server connection.`);
            }
        }
        
        // --- MODAL / HELPER FUNCTIONS ---

        function renderBookingServicesCheckboxes(selectedServiceNames = []) {
            const container = document.getElementById('bookingServicesContainer');
            if (!container) return;
            
            container.innerHTML = services.map(s => {
                // If editingId is set, get the existing service string from the booking being edited
                const isSelected = selectedServiceNames.includes(s.serviceName);

                // Use the service ID as the value for ease of lookup during save
                return `
                    <label>
                        <input type="checkbox" name="${escapeHtml(s.serviceName)}" value="${s.id}" ${isSelected ? 'checked' : ''}>
                        <span>${escapeHtml(s.serviceName)}</span>
                    </label>
                `;
            }).join('');
        }

        function updatePaycheckServiceDropdowns() {
            const serviceOptions = services.map(s => 
                `<option value="${s.id}">${escapeHtml(s.serviceName)} - $${Number(s.doulaPayout).toFixed(2)} p/u</option>`
            ).join('');

            // Only update the template, the current modal needs to be closed/reopened or manually updated
            // Since this function is mostly for saveService, we just make sure the new service is available next time.
        }

        // MODIFIED: Logic updated to only reset form if not editing, and set title dynamically
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active'); 
            
            // Clear forms ONLY if we are NOT in an edit flow (editingId is null)
            if (editingId === null) {
                const form = document.querySelector(`#${modalId} form`);
                if(form) form.reset();
            }

            if (modalId === 'bookingModal') {
                document.getElementById('bookingModalTitle').textContent = editingId ? 'Edit Booking' : 'New Booking';
                
                // For a new booking, render all checkboxes unchecked.
                const selectedServiceNames = editingId 
                    ? (bookings.find(b => b.id === editingId)?.services || '').split(', ').filter(Boolean)
                    : [];

                renderBookingServicesCheckboxes(selectedServiceNames);

            } else if (modalId === 'doulaModal') {
                document.getElementById('doulaModalTitle').textContent = editingId ? 'Edit Doula' : 'Add Doula';
            } else if (modalId === 'serviceModal') {
                document.getElementById('serviceModalTitle').textContent = editingId ? 'Edit Service' : 'Add Service';
            } else if (modalId === 'paycheckModal') {
                document.getElementById('paycheckModalTitle').textContent = editingId ? 'Edit Paycheck' : 'Generate Paycheck';
                
                // Only clear and add line for *new* paycheck
                if(editingId === null) {
                    document.getElementById('paycheckServicesContainer').innerHTML = '';
                    addPaycheckServiceLine();
                    calculatePaycheckTotals(); // Recalculate for the single default line
                } 
                // If editing, logic is handled in editPaycheck, which calls calculatePaycheckTotals()
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingId = null;
        }

        // NEW: Function to show the main app
        function showMainApp() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('mainAppContainer').style.display = 'block';
            initApp(); // Load data once logged in
        }
        
        // --- DROPDOWN POPULATION ---

        function updateDoulaDropdowns() {
            const selects = [document.getElementById('assignedDoula'), document.getElementById('paycheckDoula'), document.getElementById('paycheckDoulaFilter')];
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                
                // Filter dropdowns to only include an "All Doulas" option for the filter
                if (select.id === 'paycheckDoulaFilter') {
                     select.innerHTML = '<option value="">All Doulas</option>' + 
                        doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
                } else {
                     select.innerHTML = '<option value="">Select Doula</option>' + 
                        doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
                }
                
                select.value = currentValue;
            });
        }
        
        // --- INIT APP FUNCTION ---
        async function initApp() {
            try {
                const all = await apiGet('/api/all');
                bookings = all.bookings || [];
                doulas = all.doulas || [];
                services = all.services || [];
                paychecks = all.paychecks || [];

                renderBookings();
                renderDoulas();
                renderServices();
                renderPaychecks();
                updatePaycheckWeekFilter();
                updateDoulaDropdowns();
                renderSummary(); // Initial load of reports
            } catch (err) {
                console.error('Load failed', err);
                alert('Could not load data. Check server.');
            }
        }

        // --- INITIAL PAGE LOAD CHECK ---
        window.addEventListener('load', () => {
            if (localStorage.getItem(AUTH_KEY) === 'true') {
                // If auth key exists, show the main app immediately
                showMainApp();
            } else {
                // Otherwise, the login modal is active by default in HTML
            }
        });

    </script>
</body>
</html>