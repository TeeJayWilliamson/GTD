<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greater Toronto Doulas - Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f8f5f2;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 40px 30px;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #d4a574;
        }

        h1 {
            color: #8b7355;
            font-size: 2.8em;
            margin-bottom: 8px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .tagline {
            color: #666;
            font-size: 1.1em;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            border: 2px solid #e8e0d8;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 400;
            color: #8b7355;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .tab-btn:hover {
            background: #f8f5f2;
            border-color: #d4a574;
        }

        .tab-btn.active {
            background: #8b7355;
            color: white;
            border-color: #8b7355;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #8b7355;
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 25px;
            letter-spacing: 0.5px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 400;
            margin-bottom: 8px;
            color: #666;
            font-size: 0.95em;
            letter-spacing: 0.3px;
        }

        input, select, textarea {
            padding: 12px;
            border: 1px solid #e8e0d8;
            font-size: 1em;
            transition: border 0.3s;
            background: #fefefe;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4a574;
        }

        .btn {
            background: #8b7355;
            color: white;
            border: none;
            padding: 14px 35px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 400;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #6d5942;
        }

        .btn-secondary {
            background: #e8e0d8;
            color: #8b7355;
        }

        .btn-secondary:hover {
            background: #d4a574;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e8e0d8;
        }

        th {
            background: #f8f5f2;
            font-weight: 400;
            color: #8b7355;
            letter-spacing: 0.5px;
            font-size: 0.95em;
        }

        tr:hover {
            background: #fefdfb;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #c17b5f;
        }

        .btn-danger:hover {
            background: #a66650;
        }

        .btn-edit {
            background: #d4a574;
        }

        .btn-edit:hover {
            background: #b8906a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 2px solid #e8e0d8;
            padding: 30px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 300;
            color: #8b7355;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e8e0d8;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-btn:hover {
            color: #8b7355;
        }

        .multi-select-wrapper {
            border: 1px solid #e8e0d8;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: #fefefe;
        }

        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }

        .service-line-item {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f5f2;
        }

        .service-line-item select,
        .service-line-item input {
            flex: 1;
        }

        .btn-add-line {
            background: #d4a574;
            padding: 10px 20px;
            margin-top: 10px;
        }

        .btn-remove-line {
            background: #c17b5f;
            padding: 10px 15px;
        }

        .summary-section {
            margin-bottom: 40px;
        }

        .summary-section h3 {
            color: #8b7355;
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Greater Toronto Doulas</h1>
            <p class="tagline">Management System</p>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('bookings', event)">Bookings</button>
            <button class="tab-btn" onclick="switchTab('doulas', event)">Doulas</button>
            <button class="tab-btn" onclick="switchTab('services', event)">Services & Pricing</button>
            <button class="tab-btn" onclick="switchTab('paychecks', event)">Paychecks</button>
            <button class="tab-btn" onclick="switchTab('owner', event)">Owner Payout</button>
            <button class="tab-btn" onclick="switchTab('summary', event)">Summary Reports</button>
        </div>

        <!-- Bookings Tab -->
        <div id="bookings" class="tab-content active">
            <h2>Client Bookings</h2>
            <button class="btn" onclick="openModal('bookingModal')">+ New Booking</button>
            <table id="bookingsTable">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Services</th>
                        <th>Assigned Doula</th>
                        <th>Status</th>
                        <th>Paid</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody"></tbody>
            </table>
        </div>

        <!-- Doulas Tab -->
        <div id="doulas" class="tab-content">
            <h2>Doula Directory</h2>
            <button class="btn" onclick="openModal('doulaModal')">+ Add Doula</button>
            <table id="doulasTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Services Offered</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="doulasTableBody"></tbody>
            </table>
        </div>

        <!-- Services Tab -->
        <div id="services" class="tab-content">
            <h2>Services & Pricing</h2>
            <button class="btn" onclick="openModal('serviceModal')">+ Add Service</button>
            <table id="servicesTable">
                <thead>
                    <tr>
                        <th>Service Name</th>
                        <th>Client Price</th>
                        <th>Doula Payout</th>
                        <th>Agency Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="servicesTableBody"></tbody>
            </table>
        </div>

        <!-- Paychecks Tab -->
        <div id="paychecks" class="tab-content">
            <h2>Doula Paychecks</h2>
            <button class="btn" onclick="openModal('paycheckModal')">+ Generate Paycheck</button>
            <table id="paychecksTable">
                <thead>
                    <tr>
                        <th>Doula</th>
                        <th>Week</th>
                        <th>Invoice Date</th>
                        <th>Services</th>
                        <th>Subtotal</th>
                        <th>HST</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="paychecksTableBody"></tbody>
            </table>
        </div>

        <!-- Owner Payout Tab -->
        <div id="owner" class="tab-content">
            <h2>Owner Payout Summary</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="totalRevenue">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Doula Payouts</div>
                    <div class="stat-value" id="totalPayouts">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Income</div>
                    <div class="stat-value" id="netIncome">$0.00</div>
                </div>
            </div>
            <table id="ownerTable">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Gross Revenue</th>
                        <th>Doula Payouts</th>
                        <th>Net Income</th>
                    </tr>
                </thead>
                <tbody id="ownerTableBody"></tbody>
            </table>
        </div>

        <!-- Summary Reports Tab -->
        <div id="summary" class="tab-content">
            <h2>Summary Reports</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookingModalTitle">New Booking</h2>
                <button class="close-btn" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Assigned Doula</label>
                        <select name="assignedDoula" id="assignedDoula">
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Current">Current</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paid</label>
                        <select name="paid">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services *</label>
                        <div class="multi-select-wrapper" id="bookingServicesContainer"></div>
                    </div>
                </div>
                <button type="submit" class="btn">Save Booking</button>
            </form>
        </div>
    </div>

    <!-- Doula Modal -->
    <div id="doulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="doulaModalTitle">Add Doula</h2>
                <button class="close-btn" onclick="closeModal('doulaModal')">&times;</button>
            </div>
            <form id="doulaForm" onsubmit="saveDoula(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services Offered</label>
                        <textarea name="servicesOffered" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn">Save Doula</button>
            </form>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Add Service</h2>
                <button class="close-btn" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Name *</label>
                        <input type="text" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Price *</label>
                        <input type="number" name="clientPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Doula Payout *</label>
                        <input type="number" name="doulaPayout" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn">Save Service</button>
            </form>
        </div>
    </div>

    <!-- Paycheck Modal -->
    <div id="paycheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paycheckModalTitle">Generate Paycheck</h2>
                <button class="close-btn" onclick="closeModal('paycheckModal')">&times;</button>
            </div>
            <form id="paycheckForm" onsubmit="savePaycheck(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Doula *</label>
                        <select name="doula" id="paycheckDoula" required>
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="number" name="weekNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" name="invoiceDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Services</label>
                    <div id="paycheckServicesContainer"></div>
                    <button type="button" class="btn btn-add-line" onclick="addPaycheckServiceLine()">+ Add Service</button>
                </div>
                <button type="submit" class="btn">Generate Paycheck</button>
            </form>
        </div>
    </div>

<script>
<<<<<<< HEAD
const API_BASE = 'http://localhost:4000';
=======
const API_BASE = 'https://gtd-1rkv.onrender.com'; // '' for same origin, or e.g. 'http://localhost:3000'
>>>>>>> 2b878e2286698ee2bac52557df80bcff5476b840

let bookings = [];
let doulas = [];
let services = [];
let paychecks = [];
let editingId = null;

async function apiGet(path){
  const res = await fetch(API_BASE + path);
  if (!res.ok) throw new Error('API error');
  return res.json();
}
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API post error');
  return res.json();
}
async function apiDelete(path){
  const res = await fetch(API_BASE + path, { method: 'DELETE' });
  if (!res.ok) throw new Error('API delete error');
  return res.json();
}
async function apiPut(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API put error');
  return res.json();
}

function switchTab(tabName, e) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if (e && e.target) e.target.classList.add('active');
  
  if (tabName === 'summary') {
    renderSummary();
  }
}

function openModal(modalId) { 
  editingId = null;
  document.getElementById(modalId).classList.add('active');
  
  if (modalId === 'bookingModal') {
    document.getElementById('bookingModalTitle').textContent = 'New Booking';
    document.getElementById('bookingForm').reset();
    renderBookingServicesCheckboxes();
  } else if (modalId === 'paycheckModal') {
    document.getElementById('paycheckModalTitle').textContent = 'Generate Paycheck';
    document.getElementById('paycheckForm').reset();
    document.getElementById('paycheckServicesContainer').innerHTML = '';
    addPaycheckServiceLine();
  } else if (modalId === 'doulaModal') {
    document.getElementById('doulaModalTitle').textContent = 'Add Doula';
    document.getElementById('doulaForm').reset();
  } else if (modalId === 'serviceModal') {
    document.getElementById('serviceModalTitle').textContent = 'Add Service';
    document.getElementById('serviceForm').reset();
  }
}

function closeModal(modalId) { 
  document.getElementById(modalId).classList.remove('active'); 
  editingId = null;
}

function renderBookingServicesCheckboxes() {
  const container = document.getElementById('bookingServicesContainer');
  container.innerHTML = services.map(s => `
    <div class="multi-select-item">
      <input type="checkbox" id="service_${s.id}" value="${s.id}">
      <label for="service_${s.id}">${escapeHtml(s.serviceName)}</label>
    </div>
  `).join('');
}

function addPaycheckServiceLine() {
  const container = document.getElementById('paycheckServicesContainer');
  const lineId = Date.now();
  const serviceOptions = services.map(s => 
    `<option value="${s.id}">${escapeHtml(s.serviceName)} (${Number(s.doulaPayout).toFixed(2)})</option>`
  ).join('');
  
  const line = document.createElement('div');
  line.className = 'service-line-item';
  line.innerHTML = `
    <div class="form-group" style="margin: 0;">
      <label>Service</label>
      <select class="paycheck-service" required>
        <option value="">Select Service</option>
        ${serviceOptions}
      </select>
    </div>
    <div class="form-group" style="margin: 0;">
      <label>Quantity</label>
      <input type="number" class="paycheck-quantity" min="1" value="1" required>
    </div>
    <button type="button" class="btn btn-small btn-remove-line" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(line);
}

async function saveBooking(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const selectedServices = Array.from(document.querySelectorAll('#bookingServicesContainer input:checked'))
      .map(cb => {
        const service = services.find(s => s.id == cb.value);
        return service ? service.serviceName : '';
      })
      .filter(Boolean);
    
    const booking = {
      clientName: formData.get('clientName'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      services: selectedServices.join(', '),
      assignedDoula: formData.get('assignedDoula'),
      status: formData.get('status'),
      paid: formData.get('paid')
    };
    
    if (editingId) {
      booking.id = editingId;
      const updated = await apiPut(`/api/bookings/${editingId}`, booking);
      const idx = bookings.findIndex(b => b.id === editingId);
      if (idx !== -1) bookings[idx] = updated;
    } else {
      const created = await apiPost('/api/bookings', booking);
      bookings.push(created);
    }
    
    renderBookings();
    closeModal('bookingModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving booking: ' + err.message);
  }
}

async function saveDoula(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const doula = {
      name: formData.get('name'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      address: formData.get('address'),
      servicesOffered: formData.get('servicesOffered')
    };
    
    if (editingId) {
      doula.id = editingId;
      const updated = await apiPut(`/api/doulas/${editingId}`, doula);
      const idx = doulas.findIndex(d => d.id === editingId);
      if (idx !== -1) doulas[idx] = updated;
    } else {
      const created = await apiPost('/api/doulas', doula);
      doulas.push(created);
    }
    
    renderDoulas();
    updateDoulaDropdowns();
    closeModal('doulaModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving doula: ' + err.message);
  }
}

async function saveService(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const clientPrice = parseFloat(formData.get('clientPrice'));
    const doulaPayout = parseFloat(formData.get('doulaPayout'));
    const service = {
      serviceName: formData.get('serviceName'),
      clientPrice,
      doulaPayout,
      agencyProfit: clientPrice - doulaPayout
    };
    
    if (editingId) {
      service.id = editingId;
      const updated = await apiPut(`/api/services/${editingId}`, service);
      const idx = services.findIndex(s => s.id === editingId);
      if (idx !== -1) services[idx] = updated;
    } else {
      const created = await apiPost('/api/services', service);
      services.push(created);
    }
    
    renderServices();
    closeModal('serviceModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving service: ' + err.message);
  }
}

async function savePaycheck(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const serviceLines = document.querySelectorAll('.service-line-item');
    
    const serviceDetails = [];
    let subtotal = 0;
    
    serviceLines.forEach(line => {
      const serviceSelect = line.querySelector('.paycheck-service');
      const quantityInput = line.querySelector('.paycheck-quantity');
      
      if (serviceSelect.value && quantityInput.value) {
        const serviceId = Number(serviceSelect.value);
        const service = services.find(s => s.id === serviceId);
        const quantity = parseInt(quantityInput.value);
        
        if (service) {
          serviceDetails.push({
            name: service.serviceName,
            quantity: quantity,
            rate: service.doulaPayout,
            amount: service.doulaPayout * quantity
          });
          subtotal += service.doulaPayout * quantity;
        }
      }
    });
    
    const hst = +(subtotal * 0.13).toFixed(2);
    const paycheck = {
      doula: formData.get('doula'),
      weekNumber: formData.get('weekNumber'),
      invoiceDate: formData.get('invoiceDate'),
      serviceDetails: serviceDetails,
      subtotal: +subtotal.toFixed(2),
      hst: hst,
      total: +(subtotal + hst).toFixed(2)
    };
    
    if (editingId) {
      paycheck.id = editingId;
      const updated = await apiPut(`/api/paychecks/${editingId}`, paycheck);
      const idx = paychecks.findIndex(p => p.id === editingId);
      if (idx !== -1) paychecks[idx] = updated;
    } else {
      const created = await apiPost('/api/paychecks', paycheck);
      paychecks.push(created);
    }
    
    renderPaychecks();
    updateOwnerPayout();
    closeModal('paycheckModal');
    e.target.reset();
  } catch (err) {
    alert('Error generating paycheck: ' + err.message);
  }
}

function editBooking(id) {
  const booking = bookings.find(b => b.id === id);
  if (!booking) return;
  
  editingId = id;
  document.getElementById('bookingModalTitle').textContent = 'Edit Booking';
  const form = document.getElementById('bookingForm');
  form.elements.clientName.value = booking.clientName || '';
  form.elements.phone.value = booking.phone || '';
  form.elements.email.value = booking.email || '';
  form.elements.assignedDoula.value = booking.assignedDoula || '';
  form.elements.status.value = booking.status || '';
  form.elements.paid.value = booking.paid || '';
  
  renderBookingServicesCheckboxes();
  
  const serviceNames = (booking.services || '').split(', ').map(s => s.trim());
  serviceNames.forEach(name => {
    const service = services.find(s => s.serviceName === name);
    if (service) {
      const checkbox = document.getElementById(`service_${service.id}`);
      if (checkbox) checkbox.checked = true;
    }
  });
  
  openModal('bookingModal');
}

function editDoula(id) {
  const doula = doulas.find(d => d.id === id);
  if (!doula) return;
  
  editingId = id;
  document.getElementById('doulaModalTitle').textContent = 'Edit Doula';
  const form = document.getElementById('doulaForm');
  form.elements.name.value = doula.name || '';
  form.elements.phone.value = doula.phone || '';
  form.elements.email.value = doula.email || '';
  form.elements.address.value = doula.address || '';
  form.elements.servicesOffered.value = doula.servicesOffered || '';
  
  openModal('doulaModal');
}

function editService(id) {
  const service = services.find(s => s.id === id);
  if (!service) return;
  
  editingId = id;
  document.getElementById('serviceModalTitle').textContent = 'Edit Service';
  const form = document.getElementById('serviceForm');
  form.elements.serviceName.value = service.serviceName || '';
  form.elements.clientPrice.value = service.clientPrice || '';
  form.elements.doulaPayout.value = service.doulaPayout || '';
  
  openModal('serviceModal');
}

function editPaycheck(id) {
  const paycheck = paychecks.find(p => p.id === id);
  if (!paycheck) return;
  
  editingId = id;
  document.getElementById('paycheckModalTitle').textContent = 'Edit Paycheck';
  const form = document.getElementById('paycheckForm');
  form.elements.doula.value = paycheck.doula || '';
  form.elements.weekNumber.value = paycheck.weekNumber || '';
  form.elements.invoiceDate.value = paycheck.invoiceDate || '';
  
  const container = document.getElementById('paycheckServicesContainer');
  container.innerHTML = '';
  
  if (paycheck.serviceDetails && paycheck.serviceDetails.length > 0) {
    paycheck.serviceDetails.forEach(detail => {
      addPaycheckServiceLine();
      const lines = container.querySelectorAll('.service-line-item');
      const lastLine = lines[lines.length - 1];
      const service = services.find(s => s.serviceName === detail.name);
      if (service) {
        lastLine.querySelector('.paycheck-service').value = service.id;
        lastLine.querySelector('.paycheck-quantity').value = detail.quantity;
      }
    });
  } else {
    addPaycheckServiceLine();
  }
  
  openModal('paycheckModal');
}

async function deleteItem(type, id) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  try {
    await apiDelete(`/api/${type}s/${id}`);
    if (type === 'booking') bookings = bookings.filter(b => b.id !== id);
    if (type === 'doula') doulas = doulas.filter(d => d.id !== id);
    if (type === 'service') services = services.filter(s => s.id !== id);
    if (type === 'paycheck') paychecks = paychecks.filter(p => p.id !== id);
    
    renderBookings();
    renderDoulas();
    renderServices();
    renderPaychecks();
    updateOwnerPayout();
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

function renderBookings() {
  const tbody = document.getElementById('bookingsTableBody');
  if (!bookings || bookings.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No bookings yet.</td></tr>';
    return;
  }
  tbody.innerHTML = bookings.map(b => `
    <tr>
      <td>${escapeHtml(b.clientName)}</td>
      <td>${escapeHtml(b.phone)}</td>
      <td>${escapeHtml(b.email)}</td>
      <td>${escapeHtml(b.services)}</td>
      <td>${escapeHtml(b.assignedDoula || 'Unassigned')}</td>
      <td>${escapeHtml(b.status)}</td>
      <td>${escapeHtml(b.paid)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editBooking(${b.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('booking', ${b.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderDoulas() {
  const tbody = document.getElementById('doulasTableBody');
  if (!doulas || doulas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No doulas yet.</td></tr>';
    return;
  }
  tbody.innerHTML = doulas.map(d => `
    <tr>
      <td>${escapeHtml(d.name)}</td>
      <td>${escapeHtml(d.phone)}</td>
      <td>${escapeHtml(d.email)}</td>
      <td>${escapeHtml(d.address)}</td>
      <td>${escapeHtml(d.servicesOffered)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editDoula(${d.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('doula', ${d.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderServices() {
  const tbody = document.getElementById('servicesTableBody');
  if (!services || services.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No services yet.</td></tr>';
    return;
  }
  tbody.innerHTML = services.map(s => `
    <tr>
      <td>${escapeHtml(s.serviceName)}</td>
      <td>${Number(s.clientPrice).toFixed(2)}</td>
      <td>${Number(s.doulaPayout).toFixed(2)}</td>
      <td>${Number(s.agencyProfit).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editService(${s.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('service', ${s.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderPaychecks() {
  const tbody = document.getElementById('paychecksTableBody');
  if (!paychecks || paychecks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No paychecks yet.</td></tr>';
    return;
  }
  tbody.innerHTML = paychecks.map(p => {
    const servicesDisplay = (p.serviceDetails || []).map(sd => 
      `${sd.name} (${sd.quantity})`
    ).join(', ');
    
    return `
    <tr>
      <td>${escapeHtml(p.doula)}</td>
      <td>${escapeHtml(p.weekNumber)}</td>
      <td>${escapeHtml(p.invoiceDate)}</td>
      <td>${servicesDisplay || 'N/A'}</td>
      <td>${Number(p.subtotal).toFixed(2)}</td>
      <td>${Number(p.hst).toFixed(2)}</td>
      <td>${Number(p.total).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="editPaycheck(${p.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteItem('paycheck', ${p.id})">Delete</button>
      </td>
    </tr>
  `}).join('');
}

function updateOwnerPayout() {
  // Calculate total revenue from all paychecks
  const totalRevenue = paychecks.reduce((sum, p) => {
    const paycheckRevenue = (p.serviceDetails || []).reduce((total, sd) => {
      const service = services.find(s => s.serviceName === sd.name);
      if (service) {
        return total + (service.clientPrice * sd.quantity);
      }
      return total;
    }, 0);
    return sum + paycheckRevenue;
  }, 0);

  const totalPayouts = paychecks.reduce((sum, p) => sum + Number(p.total || 0), 0);
  const netIncome = totalRevenue - totalPayouts;

  document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)}`;
  document.getElementById('totalPayouts').textContent = `${totalPayouts.toFixed(2)}`;
  document.getElementById('netIncome').textContent = `${netIncome.toFixed(2)}`;

  // Group by week
  const weeklyData = {};
  paychecks.forEach(p => {
    const week = p.weekNumber;
    if (!weeklyData[week]) {
      weeklyData[week] = { revenue: 0, payouts: 0 };
    }
    
    const paycheckRevenue = (p.serviceDetails || []).reduce((total, sd) => {
      const service = services.find(s => s.serviceName === sd.name);
      if (service) {
        return total + (service.clientPrice * sd.quantity);
      }
      return total;
    }, 0);
    
    weeklyData[week].revenue += paycheckRevenue;
    weeklyData[week].payouts += Number(p.total || 0);
  });

  const tbody = document.getElementById('ownerTableBody');
  const weeks = Object.keys(weeklyData).sort((a, b) => Number(a) - Number(b));
  
  if (weeks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No data yet.</td></tr>';
    return;
  }
  
  tbody.innerHTML = weeks.map(week => {
    const data = weeklyData[week];
    const net = data.revenue - data.payouts;
    return `
      <tr>
        <td>Week ${week}</td>
        <td>${data.revenue.toFixed(2)}</td>
        <td>${data.payouts.toFixed(2)}</td>
        <td>${net.toFixed(2)}</td>
      </tr>
    `;
  }).join('');
}

function renderSummary() {
  const container = document.getElementById('summaryContent');
  
  // Doula summary
  const doulesSummary = {};
  paychecks.forEach(p => {
    if (!doulesSummary[p.doula]) {
      doulesSummary[p.doula] = { weeks: {}, ytd: 0 };
    }
    if (!doulesSummary[p.doula].weeks[p.weekNumber]) {
      doulesSummary[p.doula].weeks[p.weekNumber] = 0;
    }
    doulesSummary[p.doula].weeks[p.weekNumber] += Number(p.total || 0);
    doulesSummary[p.doula].ytd += Number(p.total || 0);
  });
  
  // Service summary
  const serviceSummary = {};
  paychecks.forEach(p => {
    (p.serviceDetails || []).forEach(sd => {
      if (!serviceSummary[sd.name]) {
        serviceSummary[sd.name] = { weeks: {}, ytd: 0 };
      }
      if (!serviceSummary[sd.name].weeks[p.weekNumber]) {
        serviceSummary[sd.name].weeks[p.weekNumber] = 0;
      }
      serviceSummary[sd.name].weeks[p.weekNumber] += sd.quantity;
      serviceSummary[sd.name].ytd += sd.quantity;
    });
  });
  
  let html = '<div class="summary-section"><h3>Doula Earnings Summary</h3>';
  
  Object.keys(doulesSummary).forEach(doulaName => {
    const data = doulesSummary[doulaName];
    html += `<tr style="font-weight: bold; background: #f8f5f2;"><td>YTD Total</td><td>${data.ytd.toFixed(2)}</td></tr>`;
    html += '</tbody></table>';
  });
  
  html += '</div><div class="summary-section"><h3>Service Usage Summary</h3>';
  
  Object.keys(serviceSummary).forEach(serviceName => {
    const data = serviceSummary[serviceName];
    html += `<h4 style="color: #8b7355; margin: 20px 0 10px 0;">${escapeHtml(serviceName)}</h4>`;
    html += '<table><thead><tr><th>Week</th><th>Quantity</th></tr></thead><tbody>';
    
    Object.keys(data.weeks).sort((a, b) => Number(a) - Number(b)).forEach(week => {
      html += `<tr><td>Week ${week}</td><td>${data.weeks[week]}</td></tr>`;
    });
    
    html += `<tr style="font-weight: bold; background: #f8f5f2;"><td>YTD Total</td><td>${data.ytd}</td></tr>`;
    html += '</tbody></table>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function updateDoulaDropdowns() {
  const selects = [document.getElementById('assignedDoula'), document.getElementById('paycheckDoula')];
  selects.forEach(select => {
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Doula</option>' + 
      doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
    select.value = currentValue;
  });
}

function escapeHtml(unsafe) {
  if (unsafe === undefined || unsafe === null) return '';
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

window.addEventListener('load', async () => {
  try {
    const all = await apiGet('/api/all');
    bookings = all.bookings || [];
    doulas = all.doulas || [];
    services = all.services || [];
    paychecks = all.paychecks || [];

    renderServices();
    renderBookings();
    renderDoulas();
    renderPaychecks();
    updateDoulaDropdowns();
    updateOwnerPayout();
  } catch (err) {
    console.error('Initial load failed', err);
    try {
      bookings = await apiGet('/api/bookings');
      doulas = await apiGet('/api/doulas');
      services = await apiGet('/api/services');
      paychecks = await apiGet('/api/paychecks');
      renderServices();
      renderBookings();
      renderDoulas();
      renderPaychecks();
      updateDoulaDropdowns();
      updateOwnerPayout();
    } catch (err2) {
      console.error('Fallback load failed', err2);
      alert('Could not reach backend. Make sure your JSON server is running on port 4000.');
    }
  }
});
</script>
</body>
</html>
