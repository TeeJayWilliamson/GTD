<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greater Toronto Doulas - Management System</title>
    <style>
        :root {
            --primary: #8b7355;
            --secondary: #d4a574;
            --bg: #f8f5f2;
            --white: #ffffff;
            --text: #444;
            --gray-light: #e8e0d8;
            --danger: #c17b5f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--secondary);
        }
        h1 { color: var(--primary); font-weight: 300; letter-spacing: 1px; margin-bottom: 5px;}
        .tagline { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; }

        /* --- Navigation --- */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--primary);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-btn.active, .tab-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(139, 115, 85, 0.2);
        }

        /* --- Tab Content --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            color: var(--primary);
            font-weight: 300;
            margin-bottom: 20px;
        }

        /* --- Controls (Search & Add) --- */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input {
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            font-size: 1em;
        }

        /* --- Tables (Desktop) --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; /* Gap between rows */
            margin-top: 10px;
        }
        th {
            text-align: left;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        tr {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        tr:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        
        td { padding: 15px; border-top: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); vertical-align: middle; }
        
        td:first-child { border-left: 1px solid var(--gray-light); border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: 500; color: var(--primary); }
        td:last-child { border-right: 1px solid var(--gray-light); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* --- Buttons --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
        }
        .btn:hover { background: #6d5942; }
        
        .btn-secondary { background: var(--gray-light); color: var(--primary); }
        .btn-secondary:hover { background: var(--secondary); color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.8em; margin-right: 5px; border-radius: 4px; }
        .btn-edit { background: var(--secondary); color: white; }
        .btn-edit:hover { background: #b8906a; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #a66650; }

        .btn-add-line { background: var(--secondary); margin-top: 10px; width: 100%; }
        .btn-remove-line { background: var(--danger); padding: 5px 10px; margin-left: 10px; }

        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .stat-label { font-size: 0.85em; color: #999; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 2em; font-weight: 300; color: var(--primary); }

        /* --- MOBILE RESPONSIVE LOGIC --- */
        @media (max-width: 768px) {
            .controls-bar { flex-direction: column-reverse; align-items: stretch; }
            .search-input { max-width: 100%; }
            
            /* Force table to not be a table anymore */
            table, thead, tbody, th, td, tr { display: block; }
            
            /* Hide headers */
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr {
                margin-bottom: 15px;
                border: 1px solid var(--gray-light);
                border-radius: 8px;
                padding: 5px;
                position: relative;
                cursor: pointer;
            }

            /* By default on mobile, hide all cells */
            td { 
                border: none; 
                position: relative; 
                padding: 8px 10px;
                display: none; /* HIDE EVERYTHING INITIALLY */
                text-align: left;
            }

            /* ALWAYS show the first cell (The Name) */
            td:first-child { 
                display: block; 
                font-size: 1.1em;
                border-bottom: none;
                padding-right: 40px; /* Space for arrow */
                color: var(--primary);
                font-weight: 600;
            }

            /* Add a "Chevron" arrow to indicate expandability */
            td:first-child::after {
                content: 'â–¼';
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8em;
                color: var(--secondary);
                transition: transform 0.3s;
            }

            /* When the row has class 'expanded', rotate the arrow */
            tr.expanded td:first-child::after { transform: translateY(-50%) rotate(180deg); }

            /* When row is expanded, show all cells */
            tr.expanded td { display: block; border-bottom: 1px solid #f0f0f0; }
            tr.expanded td:last-child { border-bottom: none; }

            /* Add labels so we know what the data is */
            td:not(:first-child):not(:last-child):before {
                content: attr(data-label);
                font-weight: bold;
                display: block;
                color: #999;
                font-size: 0.75em;
                text-transform: uppercase;
                margin-bottom: 2px;
            }
            
            .action-btns { text-align: right; padding-top: 10px; display: flex; justify-content: flex-end; gap: 10px;}
        }

        /* --- Modals & Forms --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fefefe; padding: 30px; border-radius: 12px;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--gray-light); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .form-group { display: flex; flex-direction: column; }
        
        label { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        input, select, textarea {
            padding: 12px; border: 1px solid var(--gray-light); border-radius: 6px;
            font-size: 1em; background: #fafafa; width: 100%;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--secondary); border-color: transparent; }
        
        .close-btn { float: right; font-size: 2rem; cursor: pointer; border: none; background: none; color: #999; line-height: 1;}
        .close-btn:hover { color: var(--primary); }

        /* Multi Select & Service Lines */
        .multi-select-wrapper { border: 1px solid var(--gray-light); padding: 10px; max-height: 150px; overflow-y: auto; background: #fafafa; border-radius: 6px; }
        .multi-select-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; }
        .multi-select-item input { width: auto; margin: 0; }
        
        .service-line-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 6px; flex-wrap: wrap; }
        .service-line-item .form-group { flex: 1; min-width: 120px; margin: 0; }
        
        /* Summary Section */
        .summary-section { margin-bottom: 40px; padding: 20px; background: white; border-radius: 8px; border: 1px solid var(--gray-light);}
        .summary-section h3 { color: var(--primary); font-size: 1.3em; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Greater Toronto Doulas</h1>
            <p class="tagline">Management System</p>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('bookings', event)">Bookings</button>
            <button class="tab-btn" onclick="switchTab('doulas', event)">Doulas</button>
            <button class="tab-btn" onclick="switchTab('services', event)">Services & Pricing</button>
            <button class="tab-btn" onclick="switchTab('paychecks', event)">Paychecks</button>
            <button class="tab-btn" onclick="switchTab('owner', event)">Owner Payout</button>
            <button class="tab-btn" onclick="switchTab('summary', event)">Summary Reports</button>
        </div>

        <div id="bookings" class="tab-content active">
            <h2>Client Bookings</h2>
            <div class="controls-bar">
                <button class="btn" onclick="openModal('bookingModal')">+ New Booking</button>
                <input type="text" class="search-input" placeholder="Search clients..." onkeyup="filterTable('bookingsTable', this.value)">
            </div>
            <table id="bookingsTable">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Services</th>
                        <th>Assigned Doula</th>
                        <th>Status</th>
                        <th>Paid</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody"></tbody>
            </table>
        </div>

        <div id="doulas" class="tab-content">
            <h2>Doula Directory</h2>
            <div class="controls-bar">
                <button class="btn" onclick="openModal('doulaModal')">+ Add Doula</button>
                <input type="text" class="search-input" placeholder="Search doulas..." onkeyup="filterTable('doulasTable', this.value)">
            </div>
            <table id="doulasTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Services Offered</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="doulasTableBody"></tbody>
            </table>
        </div>

        <div id="services" class="tab-content">
            <h2>Services & Pricing</h2>
            <div class="controls-bar">
                <button class="btn" onclick="openModal('serviceModal')">+ Add Service</button>
                <input type="text" class="search-input" placeholder="Search services..." onkeyup="filterTable('servicesTable', this.value)">
            </div>
            <table id="servicesTable">
                <thead>
                    <tr>
                        <th>Service Name</th>
                        <th>Client Price</th>
                        <th>Doula Payout</th>
                        <th>Agency Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="servicesTableBody"></tbody>
            </table>
        </div>

        <div id="paychecks" class="tab-content">
            <h2>Doula Paychecks</h2>
            <div class="controls-bar">
                <button class="btn" onclick="openModal('paycheckModal')">+ Generate Paycheck</button>
                <input type="text" class="search-input" placeholder="Search paychecks..." onkeyup="filterTable('paychecksTable', this.value)">
            </div>
            <table id="paychecksTable">
                <thead>
                    <tr>
                        <th>Doula</th>
                        <th>Week</th>
                        <th>Invoice Date</th>
                        <th>Services</th>
                        <th>Subtotal</th>
                        <th>HST</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="paychecksTableBody"></tbody>
            </table>
        </div>

        <div id="owner" class="tab-content">
            <h2>Owner Payout Summary</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="totalRevenue">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Doula Payouts</div>
                    <div class="stat-value" id="totalPayouts">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Income</div>
                    <div class="stat-value" id="netIncome">$0.00</div>
                </div>
            </div>
            <table id="ownerTable">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Gross Revenue</th>
                        <th>Doula Payouts</th>
                        <th>Net Income</th>
                    </tr>
                </thead>
                <tbody id="ownerTableBody"></tbody>
            </table>
        </div>

        <div id="summary" class="tab-content">
            <h2>Summary Reports</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookingModalTitle">New Booking</h2>
                <button class="close-btn" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Assigned Doula</label>
                        <select name="assignedDoula" id="assignedDoula">
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Current">Current</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paid</label>
                        <select name="paid">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services *</label>
                        <div class="multi-select-wrapper" id="bookingServicesContainer"></div>
                    </div>
                </div>
                <button type="submit" class="btn">Save Booking</button>
            </form>
        </div>
    </div>

    <div id="doulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="doulaModalTitle">Add Doula</h2>
                <button class="close-btn" onclick="closeModal('doulaModal')">&times;</button>
            </div>
            <form id="doulaForm" onsubmit="saveDoula(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Services Offered</label>
                        <textarea name="servicesOffered" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn">Save Doula</button>
            </form>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Add Service</h2>
                <button class="close-btn" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Name *</label>
                        <input type="text" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Price *</label>
                        <input type="number" name="clientPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Doula Payout *</label>
                        <input type="number" name="doulaPayout" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn">Save Service</button>
            </form>
        </div>
    </div>

    <div id="paycheckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paycheckModalTitle">Generate Paycheck</h2>
                <button class="close-btn" onclick="closeModal('paycheckModal')">&times;</button>
            </div>
            <form id="paycheckForm" onsubmit="savePaycheck(event)">
                <input type="hidden" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Doula *</label>
                        <select name="doula" id="paycheckDoula" required>
                            <option value="">Select Doula</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="number" name="weekNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Invoice Date *</label>
                        <input type="date" name="invoiceDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Services</label>
                    <div id="paycheckServicesContainer"></div>
                    <button type="button" class="btn btn-add-line" onclick="addPaycheckServiceLine()">+ Add Service</button>
                </div>
                <button type="submit" class="btn">Generate Paycheck</button>
            </form>
        </div>
    </div>

<script>
const API_BASE = 'https://gtd-1rkv.onrender.com'; // Change to '' if hosted on same server

let bookings = [];
let doulas = [];
let services = [];
let paychecks = [];
let editingId = null;

async function apiGet(path){
  const res = await fetch(API_BASE + path);
  if (!res.ok) throw new Error('API error');
  return res.json();
}
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API post error');
  return res.json();
}
async function apiDelete(path){
  const res = await fetch(API_BASE + path, { method: 'DELETE' });
  if (!res.ok) throw new Error('API delete error');
  return res.json();
}
async function apiPut(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('API put error');
  return res.json();
}

/* --- UI Logic --- */

function switchTab(tabName, e) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if (e && e.target) e.target.classList.add('active');
  
  if (tabName === 'summary') {
    renderSummary();
  }
}

function toggleRow(row) {
    // Only toggle on mobile devices
    if (window.innerWidth <= 768) {
        row.classList.toggle('expanded');
    }
}

function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const tr = table.getElementsByTagName("tr");
    const filter = searchText.toLowerCase();

    // Start at i=1 to skip the header row
    for (let i = 1; i < tr.length; i++) {
        let rowText = tr[i].textContent.toLowerCase();
        if (rowText.includes(filter)) {
            tr[i].style.display = "";
        } else {
            tr[i].style.display = "none";
        }
    }
}

function openModal(modalId) { 
  editingId = null;
  document.getElementById(modalId).classList.add('active');
  
  if (modalId === 'bookingModal') {
    document.getElementById('bookingModalTitle').textContent = 'New Booking';
    document.getElementById('bookingForm').reset();
    renderBookingServicesCheckboxes();
  } else if (modalId === 'paycheckModal') {
    document.getElementById('paycheckModalTitle').textContent = 'Generate Paycheck';
    document.getElementById('paycheckForm').reset();
    document.getElementById('paycheckServicesContainer').innerHTML = '';
    addPaycheckServiceLine();
  } else if (modalId === 'doulaModal') {
    document.getElementById('doulaModalTitle').textContent = 'Add Doula';
    document.getElementById('doulaForm').reset();
  } else if (modalId === 'serviceModal') {
    document.getElementById('serviceModalTitle').textContent = 'Add Service';
    document.getElementById('serviceForm').reset();
  }
}

function closeModal(modalId) { 
  document.getElementById(modalId).classList.remove('active'); 
  editingId = null;
}

function renderBookingServicesCheckboxes() {
  const container = document.getElementById('bookingServicesContainer');
  container.innerHTML = services.map(s => `
    <div class="multi-select-item">
      <input type="checkbox" id="service_${s.id}" value="${s.id}">
      <label for="service_${s.id}">${escapeHtml(s.serviceName)}</label>
    </div>
  `).join('');
}

function addPaycheckServiceLine() {
  const container = document.getElementById('paycheckServicesContainer');
  
  const serviceOptions = services.map(s => 
    `<option value="${s.id}">${escapeHtml(s.serviceName)} (${Number(s.doulaPayout).toFixed(2)})</option>`
  ).join('');
  
  const line = document.createElement('div');
  line.className = 'service-line-item';
  line.innerHTML = `
    <div class="form-group" style="margin: 0;">
      <label>Service</label>
      <select class="paycheck-service" required>
        <option value="">Select Service</option>
        ${serviceOptions}
      </select>
    </div>
    <div class="form-group" style="margin: 0;">
      <label>Quantity</label>
      <input type="number" class="paycheck-quantity" min="1" value="1" required>
    </div>
    <button type="button" class="btn btn-small btn-remove-line" onclick="this.parentElement.remove()">X</button>
  `;
  container.appendChild(line);
}

/* --- Save Functions --- */

async function saveBooking(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const selectedServices = Array.from(document.querySelectorAll('#bookingServicesContainer input:checked'))
      .map(cb => {
        const service = services.find(s => s.id == cb.value);
        return service ? service.serviceName : '';
      })
      .filter(Boolean);
    
    const booking = {
      clientName: formData.get('clientName'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      services: selectedServices.join(', '),
      assignedDoula: formData.get('assignedDoula'),
      status: formData.get('status'),
      paid: formData.get('paid')
    };
    
    if (editingId) {
      booking.id = editingId;
      const updated = await apiPut(`/api/bookings/${editingId}`, booking);
      const idx = bookings.findIndex(b => b.id === editingId);
      if (idx !== -1) bookings[idx] = updated;
    } else {
      const created = await apiPost('/api/bookings', booking);
      bookings.push(created);
    }
    
    renderBookings();
    closeModal('bookingModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving booking: ' + err.message);
  }
}

async function saveDoula(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const doula = {
      name: formData.get('name'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      address: formData.get('address'),
      servicesOffered: formData.get('servicesOffered')
    };
    
    if (editingId) {
      doula.id = editingId;
      const updated = await apiPut(`/api/doulas/${editingId}`, doula);
      const idx = doulas.findIndex(d => d.id === editingId);
      if (idx !== -1) doulas[idx] = updated;
    } else {
      const created = await apiPost('/api/doulas', doula);
      doulas.push(created);
    }
    
    renderDoulas();
    updateDoulaDropdowns();
    closeModal('doulaModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving doula: ' + err.message);
  }
}

async function saveService(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const clientPrice = parseFloat(formData.get('clientPrice'));
    const doulaPayout = parseFloat(formData.get('doulaPayout'));
    const service = {
      serviceName: formData.get('serviceName'),
      clientPrice,
      doulaPayout,
      agencyProfit: clientPrice - doulaPayout
    };
    
    if (editingId) {
      service.id = editingId;
      const updated = await apiPut(`/api/services/${editingId}`, service);
      const idx = services.findIndex(s => s.id === editingId);
      if (idx !== -1) services[idx] = updated;
    } else {
      const created = await apiPost('/api/services', service);
      services.push(created);
    }
    
    renderServices();
    closeModal('serviceModal');
    e.target.reset();
  } catch (err) {
    alert('Error saving service: ' + err.message);
  }
}

async function savePaycheck(e) {
  e.preventDefault();
  try {
    const formData = new FormData(e.target);
    const serviceLines = document.querySelectorAll('.service-line-item');
    
    const serviceDetails = [];
    let subtotal = 0;
    
    serviceLines.forEach(line => {
      const serviceSelect = line.querySelector('.paycheck-service');
      const quantityInput = line.querySelector('.paycheck-quantity');
      
      if (serviceSelect.value && quantityInput.value) {
        const serviceId = Number(serviceSelect.value);
        const service = services.find(s => s.id === serviceId);
        const quantity = parseInt(quantityInput.value);
        
        if (service) {
          serviceDetails.push({
            name: service.serviceName,
            quantity: quantity,
            rate: service.doulaPayout,
            amount: service.doulaPayout * quantity
          });
          subtotal += service.doulaPayout * quantity;
        }
      }
    });
    
    const hst = +(subtotal * 0.13).toFixed(2);
    const paycheck = {
      doula: formData.get('doula'),
      weekNumber: formData.get('weekNumber'),
      invoiceDate: formData.get('invoiceDate'),
      serviceDetails: serviceDetails,
      subtotal: +subtotal.toFixed(2),
      hst: hst,
      total: +(subtotal + hst).toFixed(2)
    };
    
    if (editingId) {
      paycheck.id = editingId;
      const updated = await apiPut(`/api/paychecks/${editingId}`, paycheck);
      const idx = paychecks.findIndex(p => p.id === editingId);
      if (idx !== -1) paychecks[idx] = updated;
    } else {
      const created = await apiPost('/api/paychecks', paycheck);
      paychecks.push(created);
    }
    
    renderPaychecks();
    updateOwnerPayout();
    closeModal('paycheckModal');
    e.target.reset();
  } catch (err) {
    alert('Error generating paycheck: ' + err.message);
  }
}

/* --- Edit & Delete Functions --- */

function editBooking(id) {
  const booking = bookings.find(b => b.id === id);
  if (!booking) return;
  
  editingId = id;
  document.getElementById('bookingModalTitle').textContent = 'Edit Booking';
  const form = document.getElementById('bookingForm');
  form.elements.clientName.value = booking.clientName || '';
  form.elements.phone.value = booking.phone || '';
  form.elements.email.value = booking.email || '';
  form.elements.assignedDoula.value = booking.assignedDoula || '';
  form.elements.status.value = booking.status || '';
  form.elements.paid.value = booking.paid || '';
  
  renderBookingServicesCheckboxes();
  
  const serviceNames = (booking.services || '').split(', ').map(s => s.trim());
  serviceNames.forEach(name => {
    const service = services.find(s => s.serviceName === name);
    if (service) {
      const checkbox = document.getElementById(`service_${service.id}`);
      if (checkbox) checkbox.checked = true;
    }
  });
  
  openModal('bookingModal');
}

function editDoula(id) {
  const doula = doulas.find(d => d.id === id);
  if (!doula) return;
  
  editingId = id;
  document.getElementById('doulaModalTitle').textContent = 'Edit Doula';
  const form = document.getElementById('doulaForm');
  form.elements.name.value = doula.name || '';
  form.elements.phone.value = doula.phone || '';
  form.elements.email.value = doula.email || '';
  form.elements.address.value = doula.address || '';
  form.elements.servicesOffered.value = doula.servicesOffered || '';
  
  openModal('doulaModal');
}

function editService(id) {
  const service = services.find(s => s.id === id);
  if (!service) return;
  
  editingId = id;
  document.getElementById('serviceModalTitle').textContent = 'Edit Service';
  const form = document.getElementById('serviceForm');
  form.elements.serviceName.value = service.serviceName || '';
  form.elements.clientPrice.value = service.clientPrice || '';
  form.elements.doulaPayout.value = service.doulaPayout || '';
  
  openModal('serviceModal');
}

function editPaycheck(id) {
  const paycheck = paychecks.find(p => p.id === id);
  if (!paycheck) return;
  
  editingId = id;
  document.getElementById('paycheckModalTitle').textContent = 'Edit Paycheck';
  const form = document.getElementById('paycheckForm');
  form.elements.doula.value = paycheck.doula || '';
  form.elements.weekNumber.value = paycheck.weekNumber || '';
  form.elements.invoiceDate.value = paycheck.invoiceDate || '';
  
  const container = document.getElementById('paycheckServicesContainer');
  container.innerHTML = '';
  
  if (paycheck.serviceDetails && paycheck.serviceDetails.length > 0) {
    paycheck.serviceDetails.forEach(detail => {
      addPaycheckServiceLine();
      const lines = container.querySelectorAll('.service-line-item');
      const lastLine = lines[lines.length - 1];
      const service = services.find(s => s.serviceName === detail.name);
      if (service) {
        lastLine.querySelector('.paycheck-service').value = service.id;
        lastLine.querySelector('.paycheck-quantity').value = detail.quantity;
      }
    });
  } else {
    addPaycheckServiceLine();
  }
  
  openModal('paycheckModal');
}

async function deleteItem(type, id) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  try {
    await apiDelete(`/api/${type}s/${id}`);
    if (type === 'booking') bookings = bookings.filter(b => b.id !== id);
    if (type === 'doula') doulas = doulas.filter(d => d.id !== id);
    if (type === 'service') services = services.filter(s => s.id !== id);
    if (type === 'paycheck') paychecks = paychecks.filter(p => p.id !== id);
    
    renderBookings();
    renderDoulas();
    renderServices();
    renderPaychecks();
    updateOwnerPayout();
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

/* --- Render Functions --- */

function renderBookings() {
  const tbody = document.getElementById('bookingsTableBody');
  if (!bookings || bookings.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No bookings yet.</td></tr>';
    return;
  }
  tbody.innerHTML = bookings.map(b => {
    const servicesDisplay = b.services ? b.services.split(', ').map(s => `<div>${escapeHtml(s)}</div>`).join('') : '';
    return `
    <tr onclick="toggleRow(this)">
      <td data-label="Client Name">${escapeHtml(b.clientName)}</td>
      <td data-label="Phone">${escapeHtml(b.phone)}</td>
      <td data-label="Email">${escapeHtml(b.email)}</td>
      <td data-label="Services">${servicesDisplay}</td>
      <td data-label="Doula">${escapeHtml(b.assignedDoula || 'Unassigned')}</td>
      <td data-label="Status">${escapeHtml(b.status)}</td>
      <td data-label="Paid">${escapeHtml(b.paid)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="event.stopPropagation(); editBooking(${b.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('booking', ${b.id})">Delete</button>
      </td>
    </tr>
  `}).join('');
}

function renderDoulas() {
  const tbody = document.getElementById('doulasTableBody');
  if (!doulas || doulas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No doulas yet.</td></tr>';
    return;
  }
  tbody.innerHTML = doulas.map(d => `
    <tr onclick="toggleRow(this)">
      <td data-label="Name">${escapeHtml(d.name)}</td>
      <td data-label="Phone">${escapeHtml(d.phone)}</td>
      <td data-label="Email">${escapeHtml(d.email)}</td>
      <td data-label="Address">${escapeHtml(d.address)}</td>
      <td data-label="Services Offered">${escapeHtml(d.servicesOffered)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="event.stopPropagation(); editDoula(${d.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('doula', ${d.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderServices() {
  const tbody = document.getElementById('servicesTableBody');
  if (!services || services.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No services yet.</td></tr>';
    return;
  }
  tbody.innerHTML = services.map(s => `
    <tr onclick="toggleRow(this)">
      <td data-label="Service Name">${escapeHtml(s.serviceName)}</td>
      <td data-label="Client Price">${Number(s.clientPrice).toFixed(2)}</td>
      <td data-label="Doula Payout">${Number(s.doulaPayout).toFixed(2)}</td>
      <td data-label="Agency Profit">${Number(s.agencyProfit).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="event.stopPropagation(); editService(${s.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('service', ${s.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderPaychecks() {
  const tbody = document.getElementById('paychecksTableBody');
  if (!paychecks || paychecks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No paychecks yet.</td></tr>';
    return;
  }
  tbody.innerHTML = paychecks.map(p => {
    const servicesDisplay = (p.serviceDetails || []).map(sd => 
      `${sd.name} (${sd.quantity})`
    ).join(', ');
    
    return `
    <tr onclick="toggleRow(this)">
      <td data-label="Doula">${escapeHtml(p.doula)}</td>
      <td data-label="Week">${escapeHtml(p.weekNumber)}</td>
      <td data-label="Invoice Date">${escapeHtml(p.invoiceDate)}</td>
      <td data-label="Services">${servicesDisplay || 'N/A'}</td>
      <td data-label="Subtotal">${Number(p.subtotal).toFixed(2)}</td>
      <td data-label="HST">${Number(p.hst).toFixed(2)}</td>
      <td data-label="Total">${Number(p.total).toFixed(2)}</td>
      <td class="action-btns">
        <button class="btn btn-small btn-edit" onclick="event.stopPropagation(); editPaycheck(${p.id})">Edit</button>
        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('paycheck', ${p.id})">Delete</button>
      </td>
    </tr>
  `}).join('');
}

function updateOwnerPayout() {
  // Calculate total revenue from all paychecks
  const totalRevenue = paychecks.reduce((sum, p) => {
    const paycheckRevenue = (p.serviceDetails || []).reduce((total, sd) => {
      const service = services.find(s => s.serviceName === sd.name);
      if (service) {
        return total + (service.clientPrice * sd.quantity);
      }
      return total;
    }, 0);
    return sum + paycheckRevenue;
  }, 0);

  const totalPayouts = paychecks.reduce((sum, p) => sum + Number(p.total || 0), 0);
  const netIncome = totalRevenue - totalPayouts;

  document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)}`;
  document.getElementById('totalPayouts').textContent = `${totalPayouts.toFixed(2)}`;
  document.getElementById('netIncome').textContent = `${netIncome.toFixed(2)}`;

  // Group by week
  const weeklyData = {};
  paychecks.forEach(p => {
    const week = p.weekNumber;
    if (!weeklyData[week]) {
      weeklyData[week] = { revenue: 0, payouts: 0 };
    }
    
    const paycheckRevenue = (p.serviceDetails || []).reduce((total, sd) => {
      const service = services.find(s => s.serviceName === sd.name);
      if (service) {
        return total + (service.clientPrice * sd.quantity);
      }
      return total;
    }, 0);
    
    weeklyData[week].revenue += paycheckRevenue;
    weeklyData[week].payouts += Number(p.total || 0);
  });

  const tbody = document.getElementById('ownerTableBody');
  const weeks = Object.keys(weeklyData).sort((a, b) => Number(a) - Number(b));
  
  if (weeks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No data yet.</td></tr>';
    return;
  }
  
  tbody.innerHTML = weeks.map(week => {
    const data = weeklyData[week];
    const net = data.revenue - data.payouts;
    return `
      <tr>
        <td>Week ${week}</td>
        <td>${data.revenue.toFixed(2)}</td>
        <td>${data.payouts.toFixed(2)}</td>
        <td>${net.toFixed(2)}</td>
      </tr>
    `;
  }).join('');
}

function renderSummary() {
  const container = document.getElementById('summaryContent');
  
  // Doula summary
  const doulesSummary = {};
  paychecks.forEach(p => {
    if (!doulesSummary[p.doula]) {
      doulesSummary[p.doula] = { weeks: {}, ytd: 0 };
    }
    if (!doulesSummary[p.doula].weeks[p.weekNumber]) {
      doulesSummary[p.doula].weeks[p.weekNumber] = 0;
    }
    doulesSummary[p.doula].weeks[p.weekNumber] += Number(p.total || 0);
    doulesSummary[p.doula].ytd += Number(p.total || 0);
  });
  
  // Service summary
  const serviceSummary = {};
  paychecks.forEach(p => {
    (p.serviceDetails || []).forEach(sd => {
      if (!serviceSummary[sd.name]) {
        serviceSummary[sd.name] = { weeks: {}, ytd: 0 };
      }
      if (!serviceSummary[sd.name].weeks[p.weekNumber]) {
        serviceSummary[sd.name].weeks[p.weekNumber] = 0;
      }
      serviceSummary[sd.name].weeks[p.weekNumber] += sd.quantity;
      serviceSummary[sd.name].ytd += sd.quantity;
    });
  });
  
  let html = '<div class="summary-section"><h3>Doula Earnings Summary</h3>';
  html += '<table><thead><tr><th>Doula Name</th><th>YTD Earnings</th></tr></thead><tbody>';
  
  Object.keys(doulesSummary).forEach(doulaName => {
    const data = doulesSummary[doulaName];
    html += `<tr><td>${escapeHtml(doulaName)}</td><td>${data.ytd.toFixed(2)}</td></tr>`;
  });
  html += '</tbody></table></div>';
  
  html += '<div class="summary-section"><h3>Service Usage Summary</h3>';
  
  Object.keys(serviceSummary).forEach(serviceName => {
    const data = serviceSummary[serviceName];
    html += `<h4 style="color: #8b7355; margin: 20px 0 10px 0;">${escapeHtml(serviceName)}</h4>`;
    html += '<table><thead><tr><th>Week</th><th>Quantity</th></tr></thead><tbody>';
    
    Object.keys(data.weeks).sort((a, b) => Number(a) - Number(b)).forEach(week => {
      html += `<tr><td>Week ${week}</td><td>${data.weeks[week]}</td></tr>`;
    });
    
    html += `<tr style="font-weight: bold; background: #f8f5f2;"><td>YTD Total</td><td>${data.ytd}</td></tr>`;
    html += '</tbody></table>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function updateDoulaDropdowns() {
  const selects = [document.getElementById('assignedDoula'), document.getElementById('paycheckDoula')];
  selects.forEach(select => {
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select Doula</option>' + 
      doulas.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');
    select.value = currentValue;
  });
}

function escapeHtml(unsafe) {
  if (unsafe === undefined || unsafe === null) return '';
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* --- Initialization --- */

window.addEventListener('load', async () => {
  try {
    const all = await apiGet('/api/all');
    bookings = all.bookings || [];
    doulas = all.doulas || [];
    services = all.services || [];
    paychecks = all.paychecks || [];

    renderServices();
    renderBookings();
    renderDoulas();
    renderPaychecks();
    updateDoulaDropdowns();
    updateOwnerPayout();
  } catch (err) {
    console.error('Initial load failed', err);
    try {
      bookings = await apiGet('/api/bookings');
      doulas = await apiGet('/api/doulas');
      services = await apiGet('/api/services');
      paychecks = await apiGet('/api/paychecks');
      renderServices();
      renderBookings();
      renderDoulas();
      renderPaychecks();
      updateDoulaDropdowns();
      updateOwnerPayout();
    } catch (err2) {
      console.error('Fallback load failed', err2);
      alert('Could not reach backend. Check console/network.');
    }
  }
});
</script>
</body>
</html>